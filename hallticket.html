<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download Hall Tickets - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600,700&display=swap">
  <style>
    body { background: #f4f8fc; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
   .container {
  width: 100%;
  max-width: 540px;
  margin: 34px auto 32px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 18px #0f3d6b22;
  padding: 28px 8px 40px 8px;
  box-sizing: border-box;
  overflow-x: hidden;
}
    .school-title { color: #0f3d6b; font-size: 1.5em; font-weight: bold; text-align: center; }
    .subtitle { color: #1762a7; font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 18px;}
    .actions { display:flex; gap:14px; margin: 18px 0 14px 0;}
    button, .custom-btn {
      background: linear-gradient(90deg,#1762a7 0%, #0f3d6b 100%);
      color:#fff; font-weight:600; border:none; padding:13px 18px;
      border-radius: 9px; font-size:1.09em; cursor:pointer; margin-top:10px;
      box-shadow:0 2px 8px #d2e7fa; transition:background 0.13s;
    }
    .custom-btn:hover, button:hover { background:#113b6c; }
    .section { margin-bottom: 20px;}
    .inline-label { font-weight:600;color:#195084; }
    .row {display:flex;gap:15px;}

    /* --- Popup --- */
    #popup-bg {
      display:none; position:fixed; left:0; top:0; right:0; bottom:0;
      background: #0007; align-items:center; justify-content:center; z-index:1000;
    }
    #popup-bg.show { display:flex; }
    #popup-content {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 30px #0f3d6b22;
      padding: 26px 15px 22px 15px;
      width: 96vw; max-width: 400px;
      box-sizing: border-box;
      display: flex; flex-direction: column; gap: 13px; align-items: stretch;
    }
    .popup-title { font-size:1.19em;color:#0f3d6b;font-weight:700;margin-bottom:10px; }
    .popup-btn-row { display:flex; gap:12px; justify-content:flex-end; margin-top:18px; flex-wrap:wrap;}
    .popup-cancel-btn { background:#e0e0e0;color:#444; font-weight:600; border-radius:9px; }
    .popup-save-btn { background: #09386c; color: #fff; font-weight:600; border-radius:9px;}
    .add-btn { background:#1dbb46; color:#fff; margin-bottom:7px; font-size:1em; border-radius:9px; }
    .remove-btn { background:#e44; color:#fff; min-width:80px; border-radius:10px; padding: 12px 0; font-size:1.08em; margin: 10px 0;}
    .subject-row { display: flex; gap: 7px; margin-bottom: 8px; align-items:center;}
    .subject-row input[type="text"], .subject-row input[type="date"] {
      flex: 1 1 0; font-size: 1.09em;
      padding: 13px 8px; border-radius: 7px; border:1.3px solid #aaa;
      background: #f8fcff; margin-bottom: 0;
    }
    .subject-row .remove-btn { flex:0 0 auto; margin-left:7px; }
    @media (max-width: 500px) {
      .container { max-width: 100vw; padding: 16px 2vw 24px 2vw; }
      #popup-content { width:99vw; max-width:99vw; }
      .subject-row { flex-direction: column; gap: 6px; margin-bottom: 8px;}
      .subject-row input, .subject-row button { width:100%; margin:0;}
      .remove-btn { margin-top: 5px;}
      .popup-btn-row { flex-direction: column; gap: 8px; }
    }
    html, body {
  max-width: 100vw;
  overflow-x: hidden;
}
  </style>
</head>
<body>
  <div class="container">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">Download Hall Tickets (PDF)</div>
    <div class="section row">
      <div>
        <span class="inline-label">Class:</span>
        <input type="text" id="className" value="10" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Section:</span>
        <input type="text" id="sectionName" value="A" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Exam:</span>
        <input type="text" id="examName" value="FA1" style="padding:8px 9px;width:88px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Year:</span>
        <input type="text" id="yearName" value="2025" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
    </div>
    <div class="section">
      <button class="custom-btn" id="editSubjectsBtn">Set Subjects & Dates</button>
    </div>
    <div class="section actions">
      <button class="custom-btn" id="downloadBtn">Download All Hall Tickets (PDF)</button>
    </div>
    <div class="note" style="color:#666; font-size:1em;">
      1. Update subject names and dates each time before download.<br>
      2. <b>Make sure hallticket.png</b> is in the same folder.
    </div>
  </div>

  <!-- Popup -->
  <div id="popup-bg"><div id="popup-content"></div></div>

<script>
  // --- PNG LOAD ---
  let hallticketImgData = null;
  async function loadHallticketImg() {
    return fetch('hallticket.png').then(resp=>resp.blob()).then(blob=>new Promise((resolve,reject)=>{
      let reader=new FileReader();
      reader.onload=ev=>{ hallticketImgData=ev.target.result; resolve();};
      reader.onerror=reject; reader.readAsDataURL(blob);
    }));
  }

  // ---- Popup Logic ----
  let subjectsForHallTicket = [];

  function showSubjectDatePopup() {
    // Always start with current values, or one empty row
    let current = (subjectsForHallTicket && subjectsForHallTicket.length)
      ? JSON.parse(JSON.stringify(subjectsForHallTicket))
      : [{subject:'', date:''}];

    let html = `
      <div class="popup-title">Enter Subjects & Dates</div>
      <form id="subjectForm" autocomplete="off">
        <div id="subjectsList"></div>
        <button type="button" class="add-btn" id="addSubjectBtn">+ Add Subject</button>
        <div class="popup-btn-row">
          <button type="button" class="popup-cancel-btn">Close</button>
          <button type="submit" class="popup-save-btn">Save</button>
        </div>
      </form>
    `;
    document.getElementById('popup-content').innerHTML = html;
    document.getElementById('popup-bg').classList.add('show');
    const subjectsList = document.getElementById('subjectsList');

    // RENDER FUNCTION
    function renderRows() {
      subjectsList.innerHTML = '';
      current.forEach((row,i) => {
        const div = document.createElement('div');
        div.className = "subject-row";
        div.innerHTML = `
          <input type="text" placeholder="Subject Name" value="${row.subject||''}" required>
          <input type="date" value="${row.date||''}" required>
          <button type="button" class="remove-btn"${current.length<=1?' style="display:none"':''}>Remove</button>
        `;
        div.querySelector('input[type="text"]').oninput = e => { current[i].subject = e.target.value; };
        div.querySelector('input[type="date"]').oninput = e => { current[i].date = e.target.value; };
        div.querySelector('.remove-btn').onclick = () => { current.splice(i,1); renderRows(); };
        subjectsList.appendChild(div);
      });
    }
    renderRows();

    document.getElementById('addSubjectBtn').onclick = () => {
      current.push({subject:'', date:''});
      renderRows();
    };

    // Form submit (Save)
    document.getElementById('subjectForm').onsubmit = function(e){
      e.preventDefault();
      // Validate: none blank
      if(current.some(s=>!s.subject.trim()||!s.date)) {
        alert('Please fill all subject names and dates!');
        return;
      }
      subjectsForHallTicket = JSON.parse(JSON.stringify(current));
      closePopup();
    };
    document.querySelector('.popup-cancel-btn').onclick = closePopup;
  }
  function closePopup(){
    document.getElementById('popup-bg').classList.remove('show');
    document.getElementById('popup-content').innerHTML = '';
  }
  document.getElementById('editSubjectsBtn').onclick = showSubjectDatePopup;

  // Generate Hall Ticket Number (customize if needed)
  function genHallTicketNum(cls,exam,year,roll){
    let rollStr = String(roll).padStart(3,'0');
    return `SPS${cls}${exam}${year}${rollStr}`;
  }

  // ---- Download PDF logic ----
  document.getElementById('downloadBtn').onclick = async ()=>{
    // Sample studentsâ€”replace with your DB data!
    let students = [
      { name: "Ravi Kumar", father: "S. Srinivas", roll: 1 },
      { name: "Anjali Devi", father: "B. Krishna", roll: 2 }
    ];
    let cls = document.getElementById('className').value.trim();
    let sec = document.getElementById('sectionName').value.trim();
    let exam = document.getElementById('examName').value.trim();
    let year = document.getElementById('yearName').value.trim();

    if (!hallticketImgData) await loadHallticketImg();

    if (!subjectsForHallTicket.length) {
      alert("Set subjects and dates first!");
      return;
    }

    // COORDS: Adjust for your PNG
    const COORDS = {
      name: [789,556],
      father: [789,624],
      class: [414,692],
      hall: [1325,699],
      exam: [992,428],
      subjStart: [432,990],
      subjGapY: 74
    };

    // PDF creation
    let pdf = new window.jspdf.jsPDF({orientation:"portrait",unit:"px",format:[1985,1403]});
    for (let idx=0; idx<students.length; idx++) {
      if (idx>0) pdf.addPage([1985,1403],'p');
      pdf.addImage(hallticketImgData,"PNG",0,0,1985,1403);
      let stu = students[idx];
      let hallNo = genHallTicketNum(cls,exam,year,stu.roll);

      // Draw exam name (centered)
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(55);
      pdf.setTextColor(30, 45, 170);
      pdf.text(exam, COORDS.exam[0], COORDS.exam[1], {align:"center"});

      // Draw fields
      pdf.setFontSize(38);
      pdf.setTextColor(30,70,70);
      pdf.text(stu.name, COORDS.name[0], COORDS.name[1]);
      pdf.text(stu.father, COORDS.father[0], COORDS.father[1]);
      pdf.text(cls, COORDS.class[0], COORDS.class[1]);
      pdf.text(hallNo, COORDS.hall[0], COORDS.hall[1]);

      // Draw subjects & dates
      pdf.setFontSize(34);
      pdf.setTextColor(34,34,34);
      let x = COORDS.subjStart[0], y = COORDS.subjStart[1];
      for (let i=0; i<subjectsForHallTicket.length; i++) {
        let s = subjectsForHallTicket[i];
        pdf.text(s.subject, x, y+i*COORDS.subjGapY);
        pdf.text(formatDate(s.date), x+520, y+i*COORDS.subjGapY);
      }
    }
    pdf.save(`HallTickets_${cls}_${sec}_${exam}.pdf`);
  };

  function formatDate(dateStr){
    if(!dateStr) return '';
    let d = new Date(dateStr);
    return d.toLocaleDateString('en-GB').replace(/\//g,'-');
  }
</script>
</body>
</html>
