<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download Hall Tickets - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600,700&display=swap">
  <style>
  body { background: #f4f8fc; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
  .container {
    max-width: 540px; margin: 34px auto 32px auto;
    background: #fff; border-radius: 16px; box-shadow: 0 4px 18px #0f3d6b22;
    padding: 28px 18px 40px 18px;
  }
  .school-title { color: #0f3d6b; font-size: 1.5em; font-weight: bold; text-align: center; }
  .subtitle { color: #1762a7; font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 18px;}
  .actions { display:flex; gap:14px; margin: 18px 0 14px 0;}
  button, .custom-btn {
    background: linear-gradient(90deg,#1762a7 0%, #0f3d6b 100%);
    color:#fff; font-weight:600; border:none; padding:13px 18px;
    border-radius: 9px; font-size:1.09em; cursor:pointer; margin-top:10px;
    box-shadow:0 2px 8px #d2e7fa; transition:background 0.13s;
  }
  .custom-btn:hover, button:hover { background:#113b6c; }
  .section { margin-bottom: 20px;}
  .inline-label { font-weight:600;color:#195084; }
  .row {display:flex;gap:15px;}

  .popup-bg {
    display:none; position:fixed; left:0; top:0; right:0; bottom:0;
    background: #0006; align-items:center; justify-content:center; z-index:1000;
  }
  .popup-bg.show { display:flex; }

  /* -- Popup Dialog -- */
  #popup-content {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 8px 30px #0f3d6b22;
    padding: 22px 12px 18px 12px;
    width: 96vw;
    max-width: 410px;
    min-width: 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }

  .popup-title { font-size:1.14em;color:#0f3d6b;font-weight:700;margin-bottom:16px;}
  .popup-btn-row { display:flex; gap:12px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap;}
  .popup-cancel-btn { background:#eee;color:#444; }
  .add-btn { background:#1dbb46; color:#fff; margin-bottom:7px; font-size:1em;}
  .remove-btn, .popup-remove-btn { background:#e44; color:#fff; min-width:65px; font-size:0.98em;}
  .note { color:#888;font-size:0.99em; margin:13px 0 0 0;}

  /* -- Subject Row (Popup) -- */
  .subject-row, .popup-row {
    display: flex;
    flex-wrap: wrap;
    gap: 7px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 9px;
  }
  .subject-row input, .subject-row select,
  .popup-row input, .popup-row select {
    flex: 1 1 120px;
    min-width: 0;
    box-sizing: border-box;
    font-size: 1em;
    padding: 9px 7px;
    border-radius:5px;
    border:1px solid #aaa;
  }
  .subject-row input[type="date"], .popup-row input[type="date"] {
    flex: 1.2 1 80px;
  }

  /* Remove button spacing for popup */
  .popup-remove-btn, .remove-btn {
    flex: 0 0 auto;
    min-width: 64px;
    padding: 8px 12px;
    margin-left: 0;
  }

  /* --- Responsive: Stack popup rows/inputs on small screens --- */
  @media (max-width: 500px) {
    .container { max-width: 100vw; padding: 16px 2vw 24px 2vw; }
    #popup-content {
      width: 99vw;
      max-width: 99vw;
      padding: 13px 2vw 17px 2vw;
    }
    .subject-row, .popup-row {
      flex-direction: column;
      gap: 7px;
      margin-bottom: 11px;
    }
    .subject-row input, .popup-row input,
    .subject-row select, .popup-row select {
      width: 100%;
      flex: 1 1 100%;
      min-width: 0;
      font-size: 1.07em;
    }
    .popup-remove-btn, .remove-btn {
      min-width: 0;
      width: 100%;
      margin: 0;
      font-size: 1em;
    }
    .popup-btn-row { flex-direction: column; gap: 8px; }
  }
</style>

</head>
<body>
  <div class="container">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">Download Hall Tickets (PDF)</div>
    <div class="section row">
      <div>
        <span class="inline-label">Class:</span>
        <input type="text" id="className" value="10" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Section:</span>
        <input type="text" id="sectionName" value="A" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Exam:</span>
        <input type="text" id="examName" value="FA1" style="padding:8px 9px;width:88px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
      <div>
        <span class="inline-label">Year:</span>
        <input type="text" id="yearName" value="2025" style="padding:8px 9px;width:74px;border-radius:7px;border:1.3px solid #aaa;" />
      </div>
    </div>
    <div class="section">
      <button class="custom-btn" id="editSubjectsBtn">Set Subjects & Dates</button>
    </div>
    <div class="section actions">
      <button class="custom-btn" id="downloadBtn">Download All Hall Tickets (PDF)</button>
    </div>
    <div class="note">
      1. Update subject names and dates each time before download.<br>
      2. <b>Make sure hallticket.png</b> is in the same folder.
    </div>
  </div>

  <!-- Popup -->
  <div class="popup-bg" id="popupBg">
    <div class="popup-content" id="popupContent"></div>
  </div>

  <script>
    // --- PNG --- 
    let hallticketImgData = null;
    async function loadHallticketImg() {
      return fetch('hallticket.png').then(resp=>resp.blob()).then(blob=>new Promise((resolve,reject)=>{
        let reader=new FileReader();
        reader.onload=ev=>{ hallticketImgData=ev.target.result; resolve();};
        reader.onerror=reject; reader.readAsDataURL(blob);
      }));
    }
    // --- Subject/Date DATA ---
    window.subjectsForHallTicket = [
      { subject: "Maths", date: "2025-03-16" },
      { subject: "Physics", date: "2025-03-18" },
      { subject: "Chemistry", date: "2025-03-20" }
    ];

    // --- POPUP for subjects/dates ---
    function showSubjectDatePopup() {
      let html = `<div class="popup-title">Enter Subjects & Dates</div>
      <form id="subjectForm">
        <div id="subjectsList"></div>
        <button type="button" class="add-btn" id="addSubjectBtn">+ Add Subject</button>
        <div class="popup-btn-row">
          <button type="button" class="popup-cancel-btn">Cancel</button>
          <button type="submit" class="custom-btn">Save</button>
        </div>
      </form>`;
      document.getElementById('popupContent').innerHTML = html;
      document.getElementById('popupBg').classList.add('show');

      function renderRows() {
        let rows = window.subjectsForHallTicket.map((row, i) => `
          <div class="subject-row">
            <input type="text" placeholder="Subject" value="${row.subject||''}" required>
            <input type="date" value="${row.date||''}" required>
            <button type="button" class="remove-btn" data-idx="${i}">Remove</button>
          </div>
        `).join('');
        document.getElementById('subjectsList').innerHTML = rows;
        // Remove buttons
        document.querySelectorAll('.remove-btn').forEach(btn=>{
          btn.onclick = function() {
            let idx = +btn.getAttribute('data-idx');
            window.subjectsForHallTicket.splice(idx,1);
            renderRows();
          }
        });
      }
      renderRows();
      document.getElementById('addSubjectBtn').onclick = ()=>{
        window.subjectsForHallTicket.push({subject:"",date:""});
        renderRows();
      };
      document.getElementById('subjectForm').onsubmit = function(e){
        e.preventDefault();
        // Save all rows
        let rows = document.querySelectorAll('.subject-row');
        let arr = [];
        let valid=true;
        rows.forEach(row=>{
          let s = row.querySelector('input[type="text"]').value.trim();
          let d = row.querySelector('input[type="date"]').value;
          if (!s || !d) valid=false;
          arr.push({subject:s,date:d});
        });
        if (!valid) return alert("Fill all subject names and dates!");
        window.subjectsForHallTicket = arr;
        closePopup();
      }
      document.querySelector('.popup-cancel-btn').onclick = closePopup;
    }
    function closePopup(){
      document.getElementById('popupBg').classList.remove('show');
      document.getElementById('popupContent').innerHTML = '';
    }
    document.getElementById('editSubjectsBtn').onclick = showSubjectDatePopup;

    // --- Generate Hall Ticket Number ---
    function genHallTicketNum(cls,exam,year,roll){
      // SPS10FA12025001
      let rollStr = String(roll).padStart(3,'0');
      return `SPS${cls}${exam}${year}${rollStr}`;
    }

    // --- Draw Hall Ticket PDF ---
    document.getElementById('downloadBtn').onclick = async ()=>{
      // Sample students: Replace this with your DB fetch
      let students = [
        { name: "Ravi Kumar", father: "S. Srinivas", roll: 1 },
        { name: "Anjali Devi", father: "B. Krishna", roll: 2 }
      ];
      let cls = document.getElementById('className').value.trim();
      let sec = document.getElementById('sectionName').value.trim();
      let exam = document.getElementById('examName').value.trim();
      let year = document.getElementById('yearName').value.trim();

      if (!hallticketImgData) await loadHallticketImg();

      // Coordinates (update for your PNG)
      const COORDS = {
        name: [789,556],
        father: [789,624],
        class: [414,692],
        hall: [1325,699],
        exam: [992,428], // center
        subjStart: [432,990], // subjects start X,Y (example)
        subjGapY: 74 // px between subject rows
      };

      // PDF creation
      let pdf = new window.jspdf.jsPDF({orientation:"portrait",unit:"px",format:[1985,1403]}); // Size of your PNG
      for (let idx=0; idx<students.length; idx++) {
        if (idx>0) pdf.addPage([1985,1403],'p');
        pdf.addImage(hallticketImgData,"PNG",0,0,1985,1403);

        let stu = students[idx];
        let hallNo = genHallTicketNum(cls,exam,year,stu.roll);

        // Draw exam name (centered)
        pdf.setFont("helvetica","bold");
        pdf.setFontSize(55);
        pdf.setTextColor(30, 45, 170);
        pdf.text(exam, COORDS.exam[0], COORDS.exam[1], {align:"center"});

        // Draw fields
        pdf.setFontSize(38);
        pdf.setTextColor(30,70,70);
        pdf.text(stu.name, COORDS.name[0], COORDS.name[1]);
        pdf.text(stu.father, COORDS.father[0], COORDS.father[1]);
        pdf.text(cls, COORDS.class[0], COORDS.class[1]);
        pdf.text(hallNo, COORDS.hall[0], COORDS.hall[1]);

        // Draw subjects & dates
        pdf.setFontSize(34);
        pdf.setTextColor(34,34,34);
        let x = COORDS.subjStart[0], y = COORDS.subjStart[1];
        for (let i=0; i<window.subjectsForHallTicket.length; i++) {
          let s = window.subjectsForHallTicket[i];
          pdf.text(s.subject, x, y+i*COORDS.subjGapY);
          pdf.text(formatDate(s.date), x+520, y+i*COORDS.subjGapY); // adjust X for date col
        }
      }
      pdf.save(`HallTickets_${cls}_${sec}_${exam}.pdf`);
    };

    function formatDate(dateStr){
      if(!dateStr) return '';
      let d = new Date(dateStr);
      return d.toLocaleDateString('en-GB').replace(/\//g,'-');
    }
  </script>
</body>
</html>
