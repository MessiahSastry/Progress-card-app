<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Download Hall Tickets - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600,700&display=swap">
  <style>
    html, body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f8fc; min-height: 100vh; }
    .fixed-header { background: #0f3d6b; color: #fff; text-align: center; padding: 18px 0 8px 0; border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; }
    .fixed-header .school-title { color: #fff; font-size: 1.5em; margin: 0; }
    .fixed-header .subtitle { color: #c9e4ff; font-size: .99em; font-weight: 400; margin: 0; }
    .fixed-header #header-exam { font-size: 1.13em; font-weight: bold; color: #fdc600; margin: 6px 0 0 0; }
    .main-content { padding: 18px 10px 80px 10px; max-width: 510px; margin: 0 auto; min-height: 60vh; }
    .screen-title { font-size: 1.4em; font-weight: bold; color: #0f3d6b; margin-bottom: 14px; margin-top: 18px; text-align:left; }
    .section { margin-bottom: 22px; }
    .inline-label { font-weight:600;color:#195084; }
    .row {display:flex;gap:15px;}
    input[type="text"], input[type="number"] {
      padding: 9px 10px; border-radius: 7px; border: 1.3px solid #aaa; font-size:1em;
      background: #f7fafd;
      width: 88px;
    }
    input[type="date"] {
      padding: 9px 10px; border-radius: 7px; border: 1.3px solid #aaa; font-size:1em;
      background: #f7fafd;
      min-width:120px;
    }
    .custom-btn, button {
      background: linear-gradient(90deg,#1762a7 0%, #0f3d6b 100%);
      color:#fff; font-weight:600; border:none; padding:13px 18px;
      border-radius: 9px; font-size:1.09em; cursor:pointer; margin-top:10px;
      box-shadow:0 2px 8px #d2e7fa; transition:background 0.13s;
      outline: none;
    }
    .custom-btn:hover, button:hover { background:#113b6c; }
    .note { color:#888;font-size:0.99em; margin:13px 0 0 0;}
    /* ----- Popup Styles ----- */
    #popup-bg { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: #0007; z-index: 2001; display: none; align-items: center; justify-content: center; }
    #popup-bg.show { display: flex !important; }
    #popup-content {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 30px #0f3d6b22;
      padding: 22px 18px 18px 18px;
      min-width: 270px; max-width: 95vw; width: 350px;
      display: flex; flex-direction: column; gap: 12px; align-items: stretch;
    }
    .popup-title { font-size: 1.14em; color: #0f3d6b; font-weight: 700; margin-bottom: 10px; }
    .popup-btn-row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }
    .popup-cancel-btn { background: #e0e0e0; color: #444; font-weight: 500; border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer; }
    .popup-action-btn { background: #0f3d6b; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: bold; cursor: pointer; }
    .popup-action-btn:hover { background: #195084; }
    .subject-row { display: flex; align-items: center; gap: 7px; margin-bottom: 9px; }
    .subject-row input[type="text"] { flex:2; }
    .subject-row input[type="date"] { flex:1.2; }
    .remove-btn {
      background: #e44; color: #fff; min-width:64px; font-size:0.98em;
      border-radius: 7px; border: none; padding: 9px 13px; cursor:pointer;
    }
    .add-btn {
      background: #1dbb46; color: #fff; margin:6px 0 14px 0; font-size:1.09em;
      padding: 9px 16px; border-radius: 7px; border: none; font-weight: 600;
    }
    /* Responsive for small screens */
    @media (max-width: 500px) {
      .main-content { max-width: 100vw; padding: 14px 2vw 20px 2vw; }
      #popup-content { width: 99vw; max-width: 99vw; padding: 13px 2vw 17px 2vw; }
      .subject-row { flex-direction: column; gap: 7px; margin-bottom: 11px; }
      .subject-row input { width: 100%; }
      .remove-btn, .add-btn, .popup-btn-row button { width: 100%; min-width:0; margin: 4px 0; }
      .popup-btn-row { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="fixed-header">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">IIT & NEET FOUNDATION</div>
    <div class="subtitle" id="header-exam" style="font-weight:600;">Download Hall Tickets (PDF)</div>
  </div>
  <div class="main-content">
    <div class="screen-title">Download Hall Tickets (PDF)</div>
    <div class="section row" style="flex-wrap:wrap; gap:13px;">
      <div>
        <span class="inline-label">Class:</span><br>
        <input type="text" id="className" value="10" style="width: 74px;" />
      </div>
      <div>
        <span class="inline-label">Section:</span><br>
        <input type="text" id="sectionName" value="A" style="width: 74px;" />
      </div>
      <div>
        <span class="inline-label">Exam:</span><br>
        <input type="text" id="examName" value="FA1" style="width: 88px;" />
      </div>
      <div>
        <span class="inline-label">Year:</span><br>
        <input type="text" id="yearName" value="2025" style="width: 74px;" />
      </div>
    </div>
    <div class="section">
      <button class="custom-btn" id="editSubjectsBtn" style="width:100%;">Set Subjects & Dates</button>
    </div>
    <div class="section">
      <button class="custom-btn" id="downloadBtn" style="width:100%;">Download All Hall Tickets (PDF)</button>
    </div>
    <div class="note">
      1. Update subject names and dates each time before download.<br>
      2. <b>Make sure hallticket.png</b> is in the same folder.
    </div>
  </div>

  <!-- Popup -->
  <div id="popup-bg"><div id="popup-content"></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- PNG --- 
    let hallticketImgData = null;
    async function loadHallticketImg() {
      return fetch('hallticket.png').then(resp=>resp.blob()).then(blob=>new Promise((resolve,reject)=>{
        let reader=new FileReader();
        reader.onload=ev=>{ hallticketImgData=ev.target.result; resolve();};
        reader.onerror=reject; reader.readAsDataURL(blob);
      }));
    }
    // --- Subject/Date DATA ---
    window.subjectsForHallTicket = [
      { subject: "Maths", date: "2025-03-16" },
      { subject: "Physics", date: "2025-03-18" },
      { subject: "Chemistry", date: "2025-03-20" }
    ];

    // POPUP base
    function showPopup(html, formId=null, submitHandler=null) {
      document.getElementById('popup-content').innerHTML = html;
      document.getElementById('popup-bg').classList.add('show');
      if(formId && submitHandler) {
        const form = document.getElementById(formId);
        if(form) form.onsubmit = submitHandler;
      }
      document.querySelectorAll('.popup-cancel-btn').forEach(btn=>{
        btn.onclick = closePopup;
      });
    }
    function closePopup() {
      document.getElementById('popup-bg').classList.remove('show');
      document.getElementById('popup-content').innerHTML = '';
    }

    // --- Subject/Date Popup (matches your exam settings style) ---
    function showSubjectDatePopup() {
      let html = `
        <form id="subjectForm" autocomplete="off">
          <div class="popup-title">Enter Subjects & Dates</div>
          <div id="subjectsList"></div>
          <button type="button" class="add-btn" id="addSubjectBtn" style="margin-bottom:8px;">+ Add Subject</button>
          <div class="popup-btn-row">
            <button type="button" class="popup-cancel-btn">Close</button>
            <button type="submit" class="popup-action-btn">Save</button>
          </div>
        </form>
      `;
      showPopup(html, 'subjectForm', function(e){
        e.preventDefault();
        let rows = document.querySelectorAll('.subject-row');
        let arr = [];
        let valid=true;
        rows.forEach(row=>{
          let s = row.querySelector('input[type="text"]').value.trim();
          let d = row.querySelector('input[type="date"]').value;
          if (!s || !d) valid=false;
          arr.push({subject:s,date:d});
        });
        if (!valid) return alert("Fill all subject names and dates!");
        window.subjectsForHallTicket = arr;
        closePopup();
      });

      function renderRows() {
        let rows = window.subjectsForHallTicket.map((row, i) => `
          <div class="subject-row">
            <input type="text" placeholder="Subject" value="${row.subject||''}" required>
            <input type="date" value="${row.date||''}" required>
            <button type="button" class="remove-btn" data-idx="${i}">Remove</button>
          </div>
        `).join('');
        document.getElementById('subjectsList').innerHTML = rows;
        document.querySelectorAll('.remove-btn').forEach(btn=>{
          btn.onclick = function() {
            let idx = +btn.getAttribute('data-idx');
            window.subjectsForHallTicket.splice(idx,1);
            renderRows();
          }
        });
      }
      renderRows();
      document.getElementById('addSubjectBtn').onclick = ()=>{
        window.subjectsForHallTicket.push({subject:"",date:""});
        renderRows();
      };
    }
    document.getElementById('editSubjectsBtn').onclick = showSubjectDatePopup;

    // --- Generate Hall Ticket Number ---
    function genHallTicketNum(cls,exam,year,roll){
      let rollStr = String(roll).padStart(3,'0');
      return `SPS${cls}${exam}${year}${rollStr}`;
    }
    // --- Draw Hall Ticket PDF ---
    document.getElementById('downloadBtn').onclick = async ()=>{
      let students = [
        { name: "Ravi Kumar", father: "S. Srinivas", roll: 1 },
        { name: "Anjali Devi", father: "B. Krishna", roll: 2 }
      ];
      let cls = document.getElementById('className').value.trim();
      let sec = document.getElementById('sectionName').value.trim();
      let exam = document.getElementById('examName').value.trim();
      let year = document.getElementById('yearName').value.trim();
      if (!hallticketImgData) await loadHallticketImg();

      // Coordinates (update for your PNG)
      const COORDS = {
        name: [789,556],
        father: [789,624],
        class: [414,692],
        hall: [1325,699],
        exam: [992,428],
        subjStart: [432,990],
        subjGapY: 74
      };
      let pdf = new window.jspdf.jsPDF({orientation:"portrait",unit:"px",format:[1985,1403]});
      for (let idx=0; idx<students.length; idx++) {
        if (idx>0) pdf.addPage([1985,1403],'p');
        pdf.addImage(hallticketImgData,"PNG",0,0,1985,1403);
        let stu = students[idx];
        let hallNo = genHallTicketNum(cls,exam,year,stu.roll);
        pdf.setFont("helvetica","bold");
        pdf.setFontSize(55);
        pdf.setTextColor(30, 45, 170);
        pdf.text(exam, COORDS.exam[0], COORDS.exam[1], {align:"center"});
        pdf.setFontSize(38);
        pdf.setTextColor(30,70,70);
        pdf.text(stu.name, COORDS.name[0], COORDS.name[1]);
        pdf.text(stu.father, COORDS.father[0], COORDS.father[1]);
        pdf.text(cls, COORDS.class[0], COORDS.class[1]);
        pdf.text(hallNo, COORDS.hall[0], COORDS.hall[1]);
        pdf.setFontSize(34);
        pdf.setTextColor(34,34,34);
        let x = COORDS.subjStart[0], y = COORDS.subjStart[1];
        for (let i=0; i<window.subjectsForHallTicket.length; i++) {
          let s = window.subjectsForHallTicket[i];
          pdf.text(s.subject, x, y+i*COORDS.subjGapY);
          pdf.text(formatDate(s.date), x+520, y+i*COORDS.subjGapY);
        }
      }
      pdf.save(`HallTickets_${cls}_${sec}_${exam}.pdf`);
    };
    function formatDate(dateStr){
      if(!dateStr) return '';
      let d = new Date(dateStr);
      return d.toLocaleDateString('en-GB').replace(/\//g,'-');
    }
  </script>
</body>
</html>
