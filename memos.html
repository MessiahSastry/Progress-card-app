<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download Progress Card PDFs - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,700">
  <style>
    html, body { background: #f4f8fc; margin:0; padding:0; font-family:'Segoe UI',Arial,sans-serif;}
    .container { max-width: 580px; margin: 30px auto 20px auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 18px #0f3d6b22; padding: 24px 18px 30px 18px;}
    .school-title { color: #0f3d6b; font-size: 1.48em; font-weight: bold; text-align: center;}
    .subtitle { color: #1762a7; font-size: 1.02em; font-weight: 500; text-align: center; margin-bottom: 16px;}
    .section { margin-bottom: 20px; }
    label { font-weight: 600; color: #195084; display: block; margin-bottom: 6px; }
    .actions { display:flex; gap:14px; margin: 15px 0 12px 0;}
    .pdf-preview { border: 2px solid #d1e5f7; border-radius: 12px; padding: 12px; margin-top: 10px; background: #fafdff;}
    .pdf-preview canvas { max-width: 100%; margin-bottom: 10px;}
    .student-list { margin: 10px 0 18px 0; }
    .student-btn { background: #f7fafd; color: #1762a7; border: 1px solid #c7d7ea; border-radius: 7px; padding: 8px 13px; margin: 0 6px 8px 0; font-size: 1em; font-weight:600; cursor:pointer;}
    .student-btn:hover { background: #eaf1fa;}
    /* Toast message */
    .toast {
      position: fixed; bottom: 36px; left: 50%; transform: translateX(-50%);
      background: #157347; color: #fff; padding: 13px 30px; border-radius: 8px;
      font-size: 1.1em; font-weight: 600; box-shadow: 0 2px 8px #0f3d6b33; z-index: 5000; opacity: 0; pointer-events: none;
      transition: opacity 0.35s;
    }
    .toast.show { opacity: 1; pointer-events: auto;}
    /* ---- Custom Dropdown Styles ---- */
    .custom-dropdown { position: relative; width:100%; font-size:1.13em;}
    .custom-dropdown-selected {
      border:1.6px solid #b3c4de; border-radius: 9px; background: #f7fafd;
      padding: 12px 16px; cursor:pointer; min-height: 43px; display:flex; align-items:center; justify-content:space-between;
      transition: border .2s;
    }
    .custom-dropdown-selected:after {
      content:"â–¼"; font-size:0.82em; color:#1962b0; margin-left: 14px; transition:.2s;
    }
    .custom-dropdown.open .custom-dropdown-selected { border-color: #0f3d6b; }
    .custom-dropdown.open .custom-dropdown-selected:after { transform:rotate(180deg);}
    .custom-dropdown-list {
      position:absolute; left:0; right:0; top:110%; background:#fff; box-shadow:0 6px 32px #0f3d6b11;
      border-radius:11px; border:1.2px solid #b3c4de; max-height:272px; overflow:auto; z-index:200;
      animation:popdrop .13s;
    }
    @keyframes popdrop { from{ opacity:0; transform:scale(0.97);} to{ opacity:1; transform:scale(1);} }
    .custom-dropdown-option {
      padding: 13px 17px; cursor:pointer; font-size:1.06em; color:#183363;
      transition:.17s; border-radius: 6px; margin:1px 6px;
    }
    .custom-dropdown-option.selected, .custom-dropdown-option:hover {
      background:#d7e7fa; color:#114e85;
    }
    .custom-dropdown-option:active { background:#b7d6f7; color:#0f3d6b;}
    @media (max-width: 640px) { .container { max-width: 99vw; padding:9vw 2vw;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">IIT & NEET FOUNDATION<br>Download Progress Cards (PDF)</div>

    <div class="section">
      <label for="yearSel">Academic Year</label>
      <div id="yearSel" class="custom-dropdown"></div>
    </div>
    <div class="section row" style="gap: 12px;">
      <div style="flex:1">
        <label for="classSel">Class</label>
        <div id="classSel" class="custom-dropdown"></div>
      </div>
      <div style="flex:1">
        <label for="sectionSel">Section</label>
        <div id="sectionSel" class="custom-dropdown"></div>
      </div>
    </div>
    <div class="section">
      <label for="examSel">Exam</label>
      <div id="examSel" class="custom-dropdown"></div>
    </div>
    <div class="actions">
      <button id="previewBtn">Preview (First 3)</button>
      <button id="downloadAllBtn">Download All (PDF)</button>
    </div>
    <div class="student-list" id="studentList"></div>
    <div class="pdf-preview" id="pdfPreview"></div>
    <div style="color:#888;font-size:.98em;margin-top:16px;">
      <b>Note:</b> Only first 3 student memos are shown as preview for speed. Download PDF for all.
    </div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
const PNG_CONFIG = [
  {
    file: "memo-nursery.png",
    classes: ["Nursery", "LKG", "UKG"],
    subjRows: [2, 8], totalRow: 9
  },
  {
    file: "memo-1-2.png",
    classes: ["1", "2", "1st", "2nd"],
    subjRows: [2, 7], totalRow: 8
  },
  {
    file: "memo-3-4-5.png",
    classes: ["3", "4", "5", "3rd", "4th", "5th"],
    subjRows: [2, 8], totalRow: 9
  },
  {
    file: "memo-6-7-8-9.png",
    classes: ["6", "7", "8", "9", "6th", "7th", "8th", "9th"],
    subjRows: [2, 11], totalRow: 12 // full as before
  },
  {
    file: "memo-10.png",
    classes: ["10", "10th"],
    subjRows: [2, 9], totalRow: 10
  }
];

// These Y positions align Mathematics1 onward 24px up for 6-9th class memos
const subjectRowsY = [
  1359, // 0
  1478, // 1
  1596, // 2 Telugu
  1715, // 3 Hindi
  1834, // 4 English 1
  1953, // 5 English 2
  2072, // 6 Mathematics 1
  2191, // 7 Mathematics 2
  2310, // 8 Physics
  2429, // 9 Chemistry
  2548, //10 Biology
  2667, //11 Social Studies/Spoken
  2786  //12 Total (for up-shift)
];

const X_MAX   = 1236;
const X_MARKS = 1502;
const X_GRADE = 1802;
const HEAD_EXAM     = [1226, 831, 60];
const HEAD_NAME     = [973, 992, 60];
const HEAD_FATHER   = [973, 1107, 60];
const HEAD_CLASS    = [500, 1216, 48];
const HEAD_ROLL     = [1300, 1216, 48];
const HEAD_PERCENT  = [1836, 1216, 48];
const HEAD_RANK     = [2128, 798, 100];

const attWorkCoords = [[725, 2956],[867, 2956],[1049, 2956],[1221, 2956],[1356, 2956],[1491, 2956],[1622, 2956],[1758, 2956],[1889, 2956],[2056, 2956]];
const attPresCoords = [[725, 3027],[867, 3027],[1049, 3027],[1221, 3027],[1356, 3027],[1491, 3027],[1622, 3027],[1758, 3027],[1889, 3027],[2056, 3027]];
const COLOR_GREEN = [22,163,74];
const COLOR_RED = [220,38,38];
const COLOR_BROWN = [139,69,19];
const COLOR_GRADE = COLOR_BROWN;
let memoImgData = null, memoImgFile = "memo-6-7-8-9.png";
let memoMap = null;

// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBXCXAB2n2qqF6lIxpX5XYnqBWHClYik14",
  authDomain: "stpatricksprogresscard.firebaseapp.com",
  projectId: "stpatricksprogresscard",
  storageBucket: "stpatricksprogresscard.appspot.com",
  messagingSenderId: "671416933178",
  appId: "1:671416933178:web:4921d57abc6eb11bd2ce03"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

firebase.auth().onAuthStateChanged(function(user) {
  if (!user) window.location.replace("index.html");
});

function sleep(ms){return new Promise(res=>setTimeout(res,ms));}
function loadMemoImg(file) {
  return fetch(file).then(resp => resp.blob()).then(blob => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = ev => { memoImgData = ev.target.result; resolve(); };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  }));
}

function showToast(msg) {
  let toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1600);
}

// ----------------- Custom Dropdowns -------------------
function makeDropdown(id, options, value, onChange) {
  const div = document.getElementById(id);
  div.innerHTML = '';
  div.classList.add('custom-dropdown');
  const selected = document.createElement('div');
  selected.className = 'custom-dropdown-selected';
  selected.tabIndex = 0;
  selected.setAttribute('role', 'combobox');
  selected.textContent = value ?? (options.length ? options[0].label : '');
  div.appendChild(selected);
  const list = document.createElement('div');
  list.className = 'custom-dropdown-list';
  list.style.display = 'none';
  options.forEach(opt => {
    const optDiv = document.createElement('div');
    optDiv.className = 'custom-dropdown-option' + (opt.value === value ? ' selected' : '');
    optDiv.textContent = opt.label;
    optDiv.onclick = e => {
      e.stopPropagation();
      selected.textContent = opt.label;
      div.value = opt.value;
      Array.from(list.children).forEach(x=>x.classList.remove('selected'));
      optDiv.classList.add('selected');
      list.style.display = 'none';
      div.classList.remove('open');
      onChange(opt.value);
    };
    list.appendChild(optDiv);
  });
  div.appendChild(list);

  selected.onclick = (e) => {
    e.stopPropagation();
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
    div.classList.toggle('open');
  };
  selected.onblur = () => { setTimeout(()=>{list.style.display='none';div.classList.remove('open');}, 150);}
  document.body.addEventListener('click', () => {list.style.display='none';div.classList.remove('open');});
  div.value = value ?? (options.length ? options[0].value : '');
}

let years = [], classes = [], sections = [], exams = [], students = [];
let yearVal, classVal, sectionVal, examVal;

async function loadYears() {
  let snap = await db.collection('years').orderBy('name', 'desc').get();
  years = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
  const opts = years.map(y => ({label: y.id, value: y.id}));
  yearVal = opts.length ? opts[0].value : '';
  makeDropdown('yearSel', opts, yearVal, v => { yearVal = v; loadClasses(); });
  await loadClasses();
}
async function loadClasses() {
  let year = yearVal;
  let snap = await db.collection('years').doc(year).collection('classes').orderBy('name').get();
  classes = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
  const opts = classes.map(c => ({label: c.name, value: c.id}));
  classVal = opts.length ? opts[0].value : '';
  makeDropdown('classSel', opts, classVal, v => { classVal = v; loadSections(); });
  await loadSections();
}
async function loadSections() {
  let year = yearVal, classId = classVal;
  if (!year || !classId) {
    makeDropdown('sectionSel', [], '', () => {});
    return;
  }
  let snap = await db.collection('years').doc(year).collection('classes').doc(classId).collection('sections').orderBy('name').get();
  sections = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
  const opts = sections.map(s => ({label: s.name, value: s.id}));
  sectionVal = opts.length ? opts[0].value : '';
  makeDropdown('sectionSel', opts, sectionVal, v => { sectionVal = v; loadExams(); });
  await loadExams();
}
async function loadExams() {
  let year = yearVal;
  let snap = await db.collection('years').doc(year).collection('exams').orderBy('name').get();
  exams = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
  const opts = exams.map(e => ({label: e.name, value: e.id}));
  examVal = opts.length ? opts[0].value : '';
  makeDropdown('examSel', opts, examVal, v => { examVal = v; loadStudents(); });
  await loadStudents();
}
async function loadStudents() {
  let year = yearVal, classId = classVal, sectionId = sectionVal;
  if (!year || !classId || !sectionId) {
    document.getElementById('studentList').innerHTML = '';
    students = [];
    return;
  }
  let snap = await db.collection('years').doc(year).collection('classes').doc(classId).collection('sections').doc(sectionId).collection('students').orderBy('roll').get();
  students = [];
  snap.forEach(doc => { let d=doc.data(); if (!d.isDeleted) students.push({id: doc.id, ...d}); });
  showStudentList();
}
function showStudentList() {
  const div = document.getElementById('studentList');
  div.innerHTML = students.length ?
    `<b>Download Individual:</b><br>` +
    students.map(stu =>
      `<button class="student-btn" onclick="downloadOne('${stu.id}')">${stu.roll ? stu.roll + '.' : ''} ${stu.name}</button>`
    ).join('')
    : `<span style="color:#999;">No students in this section.</span>`;
}

window.downloadOne = async function(studentId) {
  let student = students.find(s => s.id === studentId);
  if (!student) return;
  await generatePDF([student], true);
  showToast("Download completed!");
};
document.getElementById('previewBtn').onclick = async () => {
  document.getElementById('pdfPreview').innerHTML = `<i>Generating preview...</i>`;
  await sleep(150);
  await showPreviewPDF(students.slice(0,3));
};
document.getElementById('downloadAllBtn').onclick = async () => {
  await generatePDF(students, false);
  showToast("Download completed!");
};

// ----------- PDF helpers and generation ----------
function centerText(pdf, text, x, y, size=12, color=[0,0,0], fontStyle="bold", fontName="helvetica") {
  if ((typeof text !== 'string' && typeof text !== 'number') || typeof x !== 'number' || typeof y !== 'number' || isNaN(x) || isNaN(y)) return;
  pdf.setFont(fontName, fontStyle);
  pdf.setFontSize(size);
  pdf.setTextColor(...color);
  pdf.text(String(text), x, y, {align: 'center'});
  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(0,0,0);
}
function leftText(pdf, text, x, y, size=12, color=[0,0,0], fontStyle="bold", fontName="helvetica") {
  pdf.setFont(fontName, fontStyle);
  pdf.setFontSize(size);
  pdf.setTextColor(...color);
  pdf.text(String(text), x, y, {align: 'left'});
  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(0,0,0);
}
function formatClass(val) {
  if (!val) return '';
  return val.replace(/^(\d+)(\w+)$/, (m, num, suff) => num.toUpperCase() + suff.toLowerCase());
}
async function getMemoAndMapping(student) {
  let cl = (student.class||"").replace(/[^a-z0-9]/gi,'').toLowerCase();
  let cfg = PNG_CONFIG.find(c=>c.classes.some(name => {
    let cls=name.replace(/[^a-z0-9]/gi,'').toLowerCase();
    return cl===cls || cl===cls.replace("th","");
  })) || PNG_CONFIG[3];
  if (!memoImgData || memoImgFile!==cfg.file) {
    memoImgFile = cfg.file;
    await loadMemoImg(cfg.file);
  }
  return cfg;
}
async function fetchStudentData(stu) {
  let year = yearVal, classId = classVal, sectionId = sectionVal, examId = examVal;
  let examObj = exams.find(e => e.id === examId);
  let marksDoc = await db.collection('years').doc(year)
    .collection('classes').doc(classId)
    .collection('sections').doc(sectionId)
    .collection('students').doc(stu.id)
    .collection('marks').doc(examId).get();
  let marks = marksDoc.exists ? marksDoc.data() : {};
  let subjects = (examObj && Array.isArray(examObj.subjects)) ? examObj.subjects : [];
  let stuSubjects = [];
  let totalMarks = 0, totalMax = 0, pass = true;
  subjects.forEach((subj, i) => {
    let m = marks[subj.name] ?? '';
    let grade = '';
    if (m !== '') {
      let percent = (m / subj.max) * 100;
      grade = m < (subj.max === 50 ? 20 : 40) ? 'F'
            : percent >= 95 ? 'A+'
            : percent >= 85 ? 'A'
            : percent >= 70 ? 'B'
            : percent >= 50 ? 'C'
            : percent >= 40 ? 'D'
            : 'F';
    }
    if (m !== '') { totalMarks += +m; totalMax += +subj.max; }
    if ((subj.max === 50 && m < 20) || (subj.max === 100 && m < 40)) pass = false;
    stuSubjects.push({name: subj.name, max: subj.max, marks: m, grade});
  });
  let attSnap = { forEach: () => {} };
  if (year && classId && sectionId) {
    attSnap = await db.collection('years').doc(year)
      .collection('classes').doc(classId)
      .collection('sections').doc(sectionId)
      .collection('attendance').get();
  }
  let months = ['06','07','08','09','10','11','12','01','02','03'];
  let attArr = months.map(mo => ({work:0, pres:0}));
  attSnap.forEach(doc => {
    let date = doc.id;
    let mm = date.split('-')[1];
    let idx = months.indexOf(mm);
    if (idx >= 0) {
      attArr[idx].work += 1;
      let st = doc.data()[stu.id];
      if (st && st.M !== 'absent') attArr[idx].pres += 0.5;
      if (st && st.A !== 'absent') attArr[idx].pres += 0.5;
    }
  });
  return {
    name: stu.name, father: stu.father, roll: stu.roll,
    class: classes.find(c=>c.id===classId)?.name || '',
    percentage: totalMax ? ((totalMarks/totalMax)*100).toFixed(1) : '',
    rank: '',
    subjects: stuSubjects,
    totalMarks, totalMax,
    overallGrade: pass ? (stuSubjects.every(s=>s.grade!=='F') ? 'A+' : 'F') : 'F',
    attendance: attArr
  };
}
async function getAllStudentFullData() {
  let dataArr = [];
  for (let stu of students) {
    let dat = await fetchStudentData(stu);
    dataArr.push(dat);
  }
  dataArr.sort((a,b)=>b.totalMarks-a.totalMarks);
  let rank = 1, lastMark = null, lastRank = 1;
  dataArr.forEach((d,i) => {
    if (d.totalMarks !== lastMark) { rank = i+1; lastMark = d.totalMarks; lastRank = rank; }
    d.rank = lastRank;
  });
  dataArr.sort((a,b)=> {
    let aIdx = students.findIndex(s=>s.name===a.name&&s.roll==a.roll);
    let bIdx = students.findIndex(s=>s.name===b.name&&s.roll==b.roll);
    return aIdx-bIdx;
  });
  return dataArr;
}
async function generatePDF(studentArr, isSingle) {
  let exam = (exams.find(e=>e.id===examVal)||{}).name || '';
  let fullDataArr = [];
  if (!isSingle) var pdf = new window.jspdf.jsPDF({orientation: "portrait", unit: "px", format: [2481, 3509]});
  fullDataArr = await getAllStudentFullData();
  if (isSingle && studentArr.length === 1)
    fullDataArr = [fullDataArr.find(d=>d.name===studentArr[0].name && d.roll==studentArr[0].roll)];
  for (let idx = 0; idx < fullDataArr.length; idx++) {
    let student = fullDataArr[idx];
    let memoMap = await getMemoAndMapping(student);
    if (idx===0 && !isSingle) { pdf = new window.jspdf.jsPDF({orientation: "portrait", unit: "px", format: [2481, 3509]}); }
    else if (idx > 0 || !isSingle) pdf.addPage([2481,3509], 'p');
    pdf.addImage(memoImgData, "PNG", 0, 0, 2481, 3509);
    centerText(pdf, exam.toUpperCase(), HEAD_EXAM[0], HEAD_EXAM[1], HEAD_EXAM[2]);
    leftText(pdf, student.name?.toUpperCase() || '', HEAD_NAME[0], HEAD_NAME[1], HEAD_NAME[2], COLOR_GREEN);
    leftText(pdf, student.father?.toUpperCase() || '', HEAD_FATHER[0], HEAD_FATHER[1], HEAD_FATHER[2], COLOR_RED);
    leftText(pdf, formatClass(student.class), HEAD_CLASS[0], HEAD_CLASS[1], HEAD_CLASS[2], COLOR_GREEN);
    leftText(pdf, student.roll?.toString() || '', HEAD_ROLL[0], HEAD_ROLL[1], HEAD_ROLL[2], COLOR_GREEN);
    leftText(pdf, student.percentage, HEAD_PERCENT[0], HEAD_PERCENT[1], HEAD_PERCENT[2], COLOR_GREEN);
    let [cx,cy,s] = HEAD_RANK;
    pdf.setFillColor(120,80,30);
    pdf.ellipse(cx+10, cy+15, 55, 40, 'F');
    pdf.setFillColor(255,255,255);
    pdf.setDrawColor(...COLOR_BROWN);
    pdf.setLineWidth(8);
    pdf.ellipse(cx, cy, 52, 35, 'FD');
    pdf.setTextColor(0,0,0);
    pdf.setFontSize(s);
    pdf.setFont('helvetica','bold');
    pdf.text(student.rank.toString(), cx, cy+33, {align:'center'});
    pdf.setLineWidth(1);
    // Subject Table, from Mathematics1 on shift up for 6th-9th memo
    let subjs = student.subjects;
    let [startRow, endRow] = memoMap.subjRows;
    for (let subjIdx = 0; subjIdx < subjs.length && (startRow + subjIdx) <= endRow; subjIdx++) {
      let sy = subjectRowsY[startRow + subjIdx];
      let marksY = sy;
      if (memoImgFile === "memo-6-7-8-9.png" && subjIdx >= 4) marksY = sy - 24;
      centerText(pdf, String(subjs[subjIdx].max ?? ''), X_MAX, marksY, 60, COLOR_RED);
      centerText(pdf, String(subjs[subjIdx].marks ?? ''), X_MARKS, marksY, 60, COLOR_GREEN);
      centerText(pdf, String((subjs[subjIdx].grade ?? '')).toUpperCase(), X_GRADE, marksY, 60, COLOR_GRADE);
    }
    // Total row (move up if 6-9th)
    let totalY = subjectRowsY[memoMap.totalRow];
    if (memoImgFile === "memo-6-7-8-9.png") totalY -= 24;
    centerText(pdf, String(student.totalMax), X_MAX, totalY, 60, COLOR_RED);
    centerText(pdf, String(student.totalMarks), X_MARKS, totalY, 60, COLOR_GREEN);
    centerText(pdf, student.overallGrade, X_GRADE, totalY, 60, COLOR_GRADE);
    for (let i = 0; i < 10; i++) {
      let a = student.attendance[i] || {work:'', pres:''};
      centerText(pdf, String(a.work||''), attWorkCoords[i][0], attWorkCoords[i][1], 38);
      centerText(pdf, String(a.pres||''), attPresCoords[i][0], attPresCoords[i][1], 38);
    }
  }
  pdf.save(isSingle ? `progress_card_${fullDataArr[0].roll || 'student'}.pdf`
                    : `progress_cards_${(classes.find(c=>c.id===classVal)?.name ||'')}_${(sections.find(s=>s.id===sectionVal)?.name ||'')}.pdf`);
}

async function showPreviewPDF(stuArr) {
  let pdf;
  for (let idx = 0; idx < stuArr.length; idx++) {
    let student = stuArr[idx];
    let memoMap = await getMemoAndMapping(student);
    if (idx===0) { pdf = new window.jspdf.jsPDF({orientation: "portrait", unit: "px", format: [2481, 3509]}); }
    else pdf.addPage([2481,3509], 'p');
    pdf.addImage(memoImgData, "PNG", 0, 0, 2481, 3509);
    let exam = (exams.find(e=>e.id===examVal)||{}).name || '';
    centerText(pdf, exam.toUpperCase(), HEAD_EXAM[0], HEAD_EXAM[1], HEAD_EXAM[2]);
    leftText(pdf, student.name?.toUpperCase() || '', HEAD_NAME[0], HEAD_NAME[1], HEAD_NAME[2], COLOR_GREEN);
    leftText(pdf, student.father?.toUpperCase() || '', HEAD_FATHER[0], HEAD_FATHER[1], HEAD_FATHER[2], COLOR_RED);
    leftText(pdf, formatClass(student.class), HEAD_CLASS[0], HEAD_CLASS[1], HEAD_CLASS[2], COLOR_GREEN);
    leftText(pdf, student.roll?.toString() || '', HEAD_ROLL[0], HEAD_ROLL[1], HEAD_ROLL[2], COLOR_GREEN);
    leftText(pdf, student.percentage, HEAD_PERCENT[0], HEAD_PERCENT[1], HEAD_PERCENT[2], COLOR_GREEN);
    let [cx,cy,s] = HEAD_RANK;
    pdf.setFillColor(120,80,30);
    pdf.ellipse(cx+10, cy+15, 55, 40, 'F');
    pdf.setFillColor(255,255,255);
    pdf.setDrawColor(...COLOR_BROWN);
    pdf.setLineWidth(8);
    pdf.ellipse(cx, cy, 52, 35, 'FD');
    pdf.setTextColor(0,0,0);
    pdf.setFontSize(s);
    pdf.setFont('helvetica','bold');
    pdf.text(student.rank.toString(), cx, cy+33, {align:'center'});
    pdf.setLineWidth(1);
    let subjs = student.subjects;
    let [startRow, endRow] = memoMap.subjRows;
    for (let subjIdx = 0; subjIdx < subjs.length && (startRow + subjIdx) <= endRow; subjIdx++) {
      let sy = subjectRowsY[startRow + subjIdx];
      let marksY = sy;
      if (memoImgFile === "memo-6-7-8-9.png" && subjIdx >= 4) marksY = sy - 24;
      centerText(pdf, String(subjs[subjIdx].max ?? ''), X_MAX, marksY, 60, COLOR_RED);
      centerText(pdf, String(subjs[subjIdx].marks ?? ''), X_MARKS, marksY, 60, COLOR_GREEN);
      centerText(pdf, String((subjs[subjIdx].grade ?? '')).toUpperCase(), X_GRADE, marksY, 60, COLOR_GRADE);
    }
    let totalY = subjectRowsY[memoMap.totalRow];
    if (memoImgFile === "memo-6-7-8-9.png") totalY -= 24;
    centerText(pdf, String(student.totalMax), X_MAX, totalY, 60, COLOR_RED);
    centerText(pdf, String(student.totalMarks), X_MARKS, totalY, 60, COLOR_GREEN);
    centerText(pdf, student.overallGrade, X_GRADE, totalY, 60, COLOR_GRADE);
    for (let i = 0; i < 10; i++) {
      let a = student.attendance[i] || {work:'', pres:''};
      centerText(pdf, String(a.work||''), attWorkCoords[i][0], attWorkCoords[i][1], 38);
      centerText(pdf, String(a.pres||''), attPresCoords[i][0], attPresCoords[i][1], 38);
    }
  }
  let data = pdf.output('arraybuffer');
  let loadingTask = window['pdfjsLib'].getDocument({data});
  document.getElementById('pdfPreview').innerHTML = '';
  loadingTask.promise.then(function(pdfDoc) {
    for(let i=1;i<=pdfDoc.numPages;i++) {
      pdfDoc.getPage(i).then(function(page) {
        let viewport = page.getViewport({scale: 0.19});
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        document.getElementById('pdfPreview').appendChild(canvas);
        page.render({canvasContext: ctx, viewport: viewport});
      });
    }
  });
}
// ------------ INIT -----------
(async function() {
  await loadMemoImg(memoImgFile);
  await loadYears();
})();
  </script>
</body>
</html>
