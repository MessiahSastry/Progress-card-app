<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download Hall Tickets - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600,700&display=swap" rel="stylesheet">
  <style>
    html, body { background: #f4f8fc; margin:0; padding:0; font-family:'Segoe UI',Arial,sans-serif;}
    .container { max-width: 580px; margin: 30px auto 20px auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 18px #0f3d6b22; padding: 24px 18px 30px 18px;}
    .school-title { color: #0f3d6b; font-size: 1.7em; font-weight: bold; text-align: center;}
    .subtitle { color: #1762a7; font-size: 1.09em; font-weight: 500; text-align: center; margin-bottom: 16px;}
    .section { margin-bottom: 20px; }
    label { font-weight: 600; color: #195084; display: block; margin-bottom: 6px; }
    .row { display: flex; gap: 13px; }
    .row > div { flex:1; }
    .actions { display:flex; gap:14px; margin: 15px 0 14px 0;}
    .custom-btn, button { background: linear-gradient(90deg, #1762a7 0%, #0f3d6b 100%); color: #fff; font-weight: 600; border:none; padding: 12px 17px; border-radius: 8px; font-size: 1.09em; cursor:pointer; box-shadow: 0 2px 8px #d2e7fa; margin-bottom:0; margin-top:5px; transition: background 0.14s; }
    .custom-btn:hover, button:hover { background: #113b6c; }
    .student-list { margin: 8px 0 19px 0; padding-left: 0;}
    .student-name-row { display: flex; align-items: center; gap: 13px; margin-bottom: 7px; padding-left: 5px;}
    .student-btn { background: #e5f1fb; color: #1562a7; border: 1px solid #b4c8e9; border-radius: 6px; padding: 7px 11px; font-size: 1em; font-weight:600; cursor:pointer; margin-left: auto; margin-right: 8px; transition: background 0.13s;}
    .student-btn:hover { background: #cae6fb;}
    .pdf-preview { border: 2px solid #d1e5f7; border-radius: 12px; padding: 12px; margin-top: 10px; background: #fafdff;}
    .pdf-preview canvas { max-width: 100%; margin-bottom: 10px;}
    .toast { display: none; position: fixed; left: 50%; bottom: 38px; transform: translateX(-50%); background: #1762a7; color: #fff; padding: 13px 34px; border-radius: 9px; font-size: 1.08em; box-shadow: 0 2px 16px #19508488; z-index: 9999; opacity: 0.95; font-weight: 600;}
    @media (max-width: 640px) { .container { max-width: 99vw; padding:6vw 2vw;} .student-btn { font-size: 0.97em; } }
    select, .custom-select {width: 100%; padding:12px 11px; border: 1.5px solid #b4c8e9; border-radius: 5px; font-size: 1.08em; margin-bottom: 10px;}
  </style>
  <!-- Choices.js for custom dropdown -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">IIT & NEET FOUNDATION<br>Download Hall Tickets (PDF)</div>
    <div class="section">
      <label for="yearSel">Academic Year</label>
      <select id="yearSel" class="custom-select"></select>
    </div>
    <div class="section row">
      <div>
        <label for="classSel">Class</label>
        <select id="classSel" class="custom-select"></select>
      </div>
      <div>
        <label for="sectionSel">Section</label>
        <select id="sectionSel" class="custom-select"></select>
      </div>
    </div>
    <div class="section">
      <label for="examSel">Exam</label>
      <select id="examSel" class="custom-select"></select>
    </div>
    <div class="actions">
      <button id="previewBtn" class="custom-btn">Preview Hall Ticket</button>
      <button id="downloadAllBtn" class="custom-btn">Download (PDF)</button>
    </div>
    <div class="student-list" id="studentList"></div>
    <div class="pdf-preview" id="pdfPreview"></div>
    <div style="color:#888;font-size:.98em;margin-top:16px;">
      <b>Note:</b> Only first 3 tickets shown in preview for speed. Download PDF for all students.
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <!-- Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // PNG BG coordinates
    const coords = {
      name:      [789, 556],
      father:    [789, 624],
      class:     [414, 692],
      hallticket:[1325,699]
    };
    // --- SCHOOL HALLTICKET PNG, must be present
    const BG_IMG = "halticket.png";

    // Firebase config (keep as in your project)
    const firebaseConfig = {
      apiKey: "AIzaSyBXCXAB2n2qqF6lIxpX5XYnqBWHClYik14",
      authDomain: "stpatricksprogresscard.firebaseapp.com",
      projectId: "stpatricksprogresscard",
      storageBucket: "stpatricksprogresscard.appspot.com",
      messagingSenderId: "671416933178",
      appId: "1:671416933178:web:4921d57abc6eb11bd2ce03"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UI refs
    const yearSel = document.getElementById('yearSel');
    const classSel = document.getElementById('classSel');
    const sectionSel = document.getElementById('sectionSel');
    const examSel = document.getElementById('examSel');
    const previewBtn = document.getElementById('previewBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const studentListDiv = document.getElementById('studentList');
    const pdfPreview = document.getElementById('pdfPreview');
    const toastDiv = document.getElementById('toast');

    // Choices.js
    const classChoices = new Choices(classSel, { searchEnabled:false, itemSelectText:'', shouldSort:false });
    const sectionChoices = new Choices(sectionSel, { searchEnabled:false, itemSelectText:'', shouldSort:false });
    const examChoices = new Choices(examSel, { searchEnabled:false, itemSelectText:'', shouldSort:false });
    const yearChoices = new Choices(yearSel, { searchEnabled:false, itemSelectText:'', shouldSort:false });

    // Loader data
    let years = [], classes = [], sections = [], exams = [], students = [];
    let bgImgData = null;

    // ========== LOADERS ==============
    async function loadYears() {
      let snap = await db.collection('years').orderBy('name','desc').get();
      years = snap.docs.map(doc=>({id:doc.id,...doc.data()}));
      yearChoices.clearStore();
      yearChoices.setChoices(
        years.map(y => ({ value: y.id, label: y.id, selected: false })), 'value','label',false
      );
      yearChoices.setChoiceByValue(years[0]?.id || '');
      await loadClasses();
    }
    async function loadClasses() {
      let year = yearSel.value;
      let snap = await db.collection('years').doc(year).collection('classes').orderBy('name').get();
      classes = snap.docs.map(doc=>({id:doc.id,...doc.data()}));
      classChoices.clearStore();
      classChoices.setChoices(
        classes.map(c => ({ value: c.id, label: c.name, selected: false })), 'value','label',false
      );
      classChoices.setChoiceByValue(classes[0]?.id || '');
      await loadSections();
    }
    async function loadSections() {
      let year = yearSel.value, classId = classSel.value;
      if(!year || !classId){ sectionSel.innerHTML=''; return; }
      let snap = await db.collection('years').doc(year).collection('classes').doc(classId).collection('sections').orderBy('name').get();
      sections = snap.docs.map(doc=>({id:doc.id,...doc.data()}));
      sectionChoices.clearStore();
      sectionChoices.setChoices(
        sections.map(s => ({ value: s.id, label: s.name, selected: false })), 'value','label',false
      );
      sectionChoices.setChoiceByValue(sections[0]?.id || '');
      await loadExams();
    }
    async function loadExams() {
      let year = yearSel.value, classId = classSel.value;
      let snap = await db.collection('years').doc(year).collection('exams').get();
      exams = snap.docs.map(doc=>({id:doc.id,...doc.data()}));
      examChoices.clearStore();
      if(exams.length===0) {
        examChoices.setChoices([{ value:'', label:'No choices to choose from', selected:true }],'value','label',false);
      } else {
        examChoices.setChoices(
          exams.map(e=>({value:e.id, label:e.name, selected:false})), 'value','label',false
        );
        examChoices.setChoiceByValue(exams[0]?.id || '');
      }
      await loadStudents();
    }
    async function loadStudents() {
      let year=yearSel.value, classId=classSel.value, sectionId=sectionSel.value;
      if(!year||!classId||!sectionId){studentListDiv.innerHTML='';students=[];return;}
      let snap = await db.collection('years').doc(year).collection('classes').doc(classId).collection('sections').doc(sectionId).collection('students').orderBy('roll').get();
      students = [];
      snap.forEach(doc=>{let d=doc.data();if(!d.isDeleted)students.push({id:doc.id,...d});});
      showStudentList();
    }
    function showStudentList() {
      studentListDiv.innerHTML = students.length ?
        `<div style="font-weight:600;color:#195084;margin-bottom:8px;">Download Individual:</div>` +
        students.map(stu =>
          `<div class="student-name-row"><span style="flex:1;text-align:left;font-size:1.08em;color:#14305a;">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
          <button class="student-btn" onclick="downloadOne('${stu.id}')">Download</button></div>`
        ).join('')
        : `<span style="color:#999;">No students in this section.</span>`;
    }
    yearSel.onchange = ()=>loadClasses();
    classSel.onchange = ()=>loadSections();
    sectionSel.onchange = ()=>loadExams();
    examSel.onchange = ()=>loadStudents();

    // ================== PNG LOAD ===============
    async function loadBgImg() {
      if(bgImgData) return;
      const resp = await fetch(BG_IMG);
      const blob = await resp.blob();
      bgImgData = await new Promise(res=>{
        const reader = new FileReader();
        reader.onload = ev=>res(ev.target.result);
        reader.readAsDataURL(blob);
      });
    }

    // ========== HALLTICKET NUMBER ============
    function genHallTicketNo(stu, examName, year) {
      // SPS + Class number (digits only) + ExamName (no spaces) + Year + Roll (3 digit)
      let cl = (stu.class||"").replace(/[^0-9]/g,'');
      let ex = (examName||"").replace(/\s/g,'');
      let roll = stu.roll ? String(stu.roll).padStart(3,'0') : "001";
      return `SPS${cl}${ex}${year}${roll}`;
    }

    // ========== PDF GEN ============
    async function generateHallTicketPDF(studentArr, isPreview) {
      await loadBgImg();
      let examObj = exams.find(e=>e.id===examSel.value) || {};
      let examName = examObj.name || (examSel.options[examSel.selectedIndex]?.textContent||"");
      let year = yearSel.value;
      const { jsPDF } = window.jspdf;
      let pdf = new jsPDF({orientation:"landscape", unit:"px", format:[1540,1086]});
      for(let idx=0; idx<studentArr.length; idx++) {
        let stu = studentArr[idx];
        if(idx>0) pdf.addPage([1540,1086],'l');
        pdf.addImage(bgImgData, "PNG", 0, 0, 1540, 1086);
        // NAME
        pdf.setFont("helvetica","bold"); pdf.setFontSize(30); pdf.setTextColor(25,80,132);
        pdf.text(stu.name?.toUpperCase()||'', coords.name[0], coords.name[1]);
        // FATHER
        pdf.setFont("helvetica","normal"); pdf.setFontSize(29); pdf.setTextColor(20,32,100);
        pdf.text(stu.father?.toUpperCase()||'', coords.father[0], coords.father[1]);
        // CLASS
        pdf.setFont("helvetica","bold"); pdf.setFontSize(29); pdf.setTextColor(22,163,74);
        pdf.text(stu.class||'', coords.class[0], coords.class[1]);
        // HALLTICKET
        pdf.setFont("helvetica","bold"); pdf.setFontSize(29); pdf.setTextColor(20,32,100);
        pdf.text(genHallTicketNo(stu, examName, year), coords.hallticket[0], coords.hallticket[1]);
      }
      if(isPreview) {
        // Show preview (first ticket)
        let url = pdf.output("dataurlstring");
        pdfPreview.innerHTML = `<iframe src="${url}" style="width:100%;height:420px;border:none;border-radius:8px;"></iframe>`;
      } else {
        pdf.save(`halltickets_${year}_${examName}.pdf`);
      }
    }

    window.downloadOne = async function(studentId) {
      let stu = students.find(s=>s.id===studentId);
      if(!stu) return;
      await generateHallTicketPDF([stu], false);
      showToast("Download completed.");
    };

    previewBtn.onclick = async () => {
      pdfPreview.innerHTML = `<i>Generating preview...</i>`;
      await generateHallTicketPDF(students.slice(0,1), true);
    };
    downloadAllBtn.onclick = async () => {
      await generateHallTicketPDF(students, false);
      showToast("Download completed.");
    };

    function showToast(msg) {
      toastDiv.innerHTML = msg;
      toastDiv.style.display = 'block';
      setTimeout(()=>{toastDiv.style.display='none';}, 2000);
    }
    // INIT
    (async function() {
      await loadBgImg();
      await loadYears();
    })();
  </script>
</body>
</html>
