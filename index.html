<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Campus Conncet</title>
  <meta name="theme-color" content="#0f3d6b">
  <link rel="manifest" href="manifest.json?v=A6">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    html, body {
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f8fc;
      min-width: 100vw;
      overflow-x: hidden;
    }
    #login-root {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      background: #f4f8fc;
    }
    .login-box {
      width: 96vw;
      max-width: 350px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 24px #0f3d6b14;
      padding: 26px 18px 20px 18px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }
    .login-box input {
    padding: 10px 12px;
    font-size: 1.08em;
    margin-bottom: 7px;
    border-radius: 6px;
    border: 1.3px solid #bcd6ef;
    background: #f7fafd;
    transition: border-color .2s;

    width: 100%;
    box-sizing: border-box;
}
    .login-box input:focus { outline: none; border-color: #0f3d6b; }
    .btn-email {
      font-size: 1em;
      border: none;
      padding: 12px 0;
      border-radius: 8px;
      margin-top: 6px;
      font-weight: bold;
      background: #1762a7;
      color: #fff;
      cursor: pointer;
      margin-bottom: 3px;
      transition: background 0.17s;
    }
    ::-webkit-scrollbar { width: 0; background: transparent; }
    #reset-modal input { width:100%; max-width:100%; box-sizing:border-box; display:block; }
  </style>
</head>
<body>
  <div id="login-root"></div>
<!-- Splash Overlay (after-login) -->
<div id="splash" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#fff;z-index:2000;">
  <div style="display:flex;flex-direction:column;align-items:center;gap:14px;">
    <img id="splashLogoImg" src="" alt="School Logo" style="width:120px;height:120px;object-fit:contain;"/>
    <div id="splashSchoolName" style="font-weight:800;color:#0f3d6b;font-size:1.1em;text-align:center;"></div>
    <div style="width:44px;height:44px;border:4px solid #e1ecf7;border-top-color:#1762a7;border-radius:50%;animation:spin 1s linear infinite;"></div>
  </div>
</div>
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script>
    if (typeof firebase === "undefined") alert("Firebase not loaded!");
    const firebaseConfig = {
      apiKey: "AIzaSyBXCXAB2n2qqF6lIxpX5XYnqBWHClYik14",
      authDomain: "stpatricksprogresscard.firebaseapp.com",
      projectId: "stpatricksprogresscard",
      storageBucket: "stpatricksprogresscard.appspot.com",
      messagingSenderId: "671416933178",
      appId: "1:671416933178:web:4921d57abc6eb11bd2ce03"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const db = firebase.firestore();

// Splash helpers (Firebase Storage logo)
async function resolveLogoUrl(schoolData) {
  try {
    const direct = schoolData?.logoUrl || schoolData?.logo || schoolData?.logo1;
    if (direct && (/^https?:/i.test(direct) || /^data:/i.test(direct))) return direct;

    const path = schoolData?.logoPath || schoolData?.logoStoragePath || schoolData?.storageLogo || schoolData?.logoRef || schoolData?.storagePath;
    if (!path) return null;

    const storage = firebase.storage();
    const ref = path.startsWith('gs://') ? storage.refFromURL(path) : storage.ref(path);
    return await ref.getDownloadURL();
  } catch (e) {
    console.warn('Logo fetch failed:', e);
    return null;
  }
}

async function showSplash() {
  const splash = document.getElementById('splash');
  if (splash) splash.style.display = 'flex';

  let schoolData = {};
  try { schoolData = JSON.parse(localStorage.getItem('schoolData') || '{}'); } catch (e) {}

  const schoolName = schoolData?.name || schoolData?.schoolName || 'Your School';
  const nameEl = document.getElementById('splashSchoolName');
  if (nameEl) nameEl.textContent = schoolName;

  const img = document.getElementById('splashLogoImg');
  if (img) {
    let url = await resolveLogoUrl(schoolData);
    if (!url) url = 'schoollogo1.png'; // fallback
    img.src = url;
    img.onerror = () => { img.style.display = 'none'; };
  }
}

async function goToDashboard() {
  try { await showSplash(); } catch (e) {}
  setTimeout(() => { window.location.href = 'dashboard.html'; }, 1200);
}

    const loginRoot = document.getElementById('login-root');

    function showLoginUI() {
      if (!loginRoot) return;
      loginRoot.innerHTML = `
        <div class="login-box">
          <div style="font-weight:bold; color:#0f3d6b; font-size:1.3em; text-align:center; margin-bottom:6px;">
            Login to Your School Account
          </div>
          <input type="email" id="email" placeholder="Email" autocomplete="username">
          <input type="password" id="password" placeholder="Password" autocomplete="current-password">
          <button class="btn-email" onclick="emailSignIn()">Sign in</button>
         </div>
      `;
      loginRoot.style.display = 'flex';
    }

    window.emailSignIn = function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) return alert('Enter email and password!');
      auth.signInWithEmailAndPassword(email, password)
        .then(async userCred => {
  const email = (userCred.user.email || '').trim().toLowerCase();
  const snap = await db.collection('users').where('email', '==', email).get();

  if (snap.empty) throw new Error("User profile not found in Firestore.");

  if (snap.size > 1) {
    // If same email is used for multiple schools, pick the first for now
    console.warn("Multiple user docs for this email; using the first.");
  }
  const userDoc = snap.docs[0];
  const userData = userDoc.data();
  localStorage.setItem("userData", JSON.stringify(userData));

  const schoolDoc = await db.collection('schools').doc(userData.schoolId).get();
  if (!schoolDoc.exists) throw new Error("School info not found!");
  const schoolData = schoolDoc.data();
  localStorage.setItem("schoolData", JSON.stringify(schoolData));
  goToDashboard();
    })
        .catch(err => {
          let msg = err.message;
          if (msg.includes('no user')) msg = "No such account.";
          if (msg.includes('password is invalid')) msg = "Incorrect password.";
          alert(msg);
        });
    };

    auth.onAuthStateChanged(function (user) {
  if (user) {
    // If already logged in, check localStorage and redirect
    const cachedUser = localStorage.getItem("userData");
    const cachedSchool = localStorage.getItem("schoolData");
    if (cachedUser && cachedSchool) {
      goToDashboard();
      return;
    }

    // Fresh fetch by EMAIL (not doc(uid))
    (async () => {
      const email = (user.email || '').trim().toLowerCase();
      const snap = await db.collection('users').where('email', '==', email).get();
      if (snap.empty) throw new Error("User profile not found in Firestore.");

      const userDoc = snap.docs[0];
      const userData = userDoc.data();
      localStorage.setItem("userData", JSON.stringify(userData));

      const schoolDoc = await db.collection('schools').doc(userData.schoolId).get();
      if (!schoolDoc.exists) throw new Error("School info not found!");
      const schoolData = schoolDoc.data();
      localStorage.setItem("schoolData", JSON.stringify(schoolData));

      window.location.replace("dashboard.html");
    })().catch((e) => {
      console.warn(e);
      showLoginUI();
    });

  } else {
    showLoginUI();
  }
});
    // --- Forgot Password via Phone OTP ---
// --- Reset Password via Email (no Cloud Functions) ---
function openEmailReset() {
  document.getElementById('email-reset-modal').style.display = 'flex';
}

function closeEmailReset() {
  document.getElementById('email-reset-modal').style.display = 'none';
}

async function sendResetEmail() {
  try {
    const email = (document.getElementById('reset-email')?.value || '').trim();
    if (!email) {
      alert('Enter your email.');
      return;
    }
    await firebase.auth().sendPasswordResetEmail(email);
    alert(`Reset link sent to ${email}. Check your inbox.`);
    closeEmailReset();
  } catch (error) {
    alert(error?.message || 'Failed to send reset email.');
  }
}

  </script>
  <!-- Reset Password Modal -->
<div id="email-reset-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#00000066;z-index:2000;">
  <div style="width:92vw;max-width:380px;background:#fff;border-radius:16px;box-shadow:0 10px 28px #0f3d6b22;padding:18px 16px;">
    <div style="font-weight:700;color:#0f3d6b;font-size:1.2em;text-align:center;margin-bottom:6px;">Reset via Email</div>
    <div style="font-size:.92em;color:#335;opacity:.9;text-align:center;margin-bottom:12px;">Enter your registered email. Weâ€™ll send a reset link.</div>

    <input id="reset-email" type="email" placeholder="your@email.com"
           style="width:100%;padding:10px 12px;font-size:1.02em;border:1.2px solid #bcd6ef;border-radius:8px;background:#f7fafd;margin-bottom:10px;">

    <button onclick="sendResetEmail()" class="btn-email" style="width:100%;">Send reset link</button>

    <div style="text-align:center;margin-top:10px;">
      <button onclick="closeEmailReset()" style="background:none;border:none;color:#1762a7;font-weight:600;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>
  <style>
  #cc-alert {
    position: fixed; inset: 0; display: none;
    align-items: center; justify-content: center;
    background: #00000066; z-index: 3000;
  }
  #cc-alert .box {
    width: 92vw; max-width: 360px; background: #fff;
    border-radius: 14px; box-shadow: 0 10px 28px #0f3d6b22;
    padding: 16px;
  }
  #cc-alert .title { font-weight: 800; color: #0f3d6b; font-size: 1.05em; margin-bottom: 8px; }
  #cc-alert .msg { color: #223; margin-bottom: 12px; white-space: pre-wrap; }
  #cc-alert .ok {
    width: 100%; padding: 10px; border: none; border-radius: 8px;
    background: #1762a7; color: #fff; font-weight: 700; cursor: pointer;
  }
</style>

<div id="cc-alert" role="dialog" aria-modal="true" aria-labelledby="cc-alert-title">
  <div class="box">
    <div id="cc-alert-title" class="title">CampusConnect</div>
    <div id="cc-alert-msg" class="msg"></div>
    <button class="ok" onclick="closeCcAlert()">OK</button>
  </div>
</div>

<script>
  function ccAlert(message, title = 'CampusConnect') {
    document.getElementById('cc-alert-title').textContent = title;
    document.getElementById('cc-alert-msg').textContent = String(message ?? '');
    document.getElementById('cc-alert').style.display = 'flex';
  }
  function closeCcAlert() {
    document.getElementById('cc-alert').style.display = 'none';
  }
  // Optional: replace native alert everywhere
  window.alert = (msg) => ccAlert(msg);
</script>
</body>
</html>









