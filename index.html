<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusConnect – Multi School Progress Card App</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    html, body {
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f8fc;
      min-width: 100vw;
      overflow-x: hidden;
    }
    #login-root {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      background: #f4f8fc;
    }
    .login-box {
      width: 96vw;
      max-width: 350px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 24px #0f3d6b14;
      padding: 26px 18px 20px 18px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }
    .login-box input {
    padding: 10px 12px;
    font-size: 1.08em;
    margin-bottom: 7px;
    border-radius: 6px;
    border: 1.3px solid #bcd6ef;
    background: #f7fafd;
    transition: border-color .2s;

    width: 100%;
    box-sizing: border-box;
}
    .login-box input:focus { outline: none; border-color: #0f3d6b; }
    .btn-email {
      font-size: 1em;
      border: none;
      padding: 12px 0;
      border-radius: 8px;
      margin-top: 6px;
      font-weight: bold;
      background: #1762a7;
      color: #fff;
      cursor: pointer;
      margin-bottom: 3px;
      transition: background 0.17s;
    }
    ::-webkit-scrollbar { width: 0; background: transparent; }
    #reset-modal input { width:100%; max-width:100%; box-sizing:border-box; display:block; }
  </style>
</head>
<body>
  <div id="login-root"></div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script>
    if (typeof firebase === "undefined") alert("Firebase not loaded!");
    const firebaseConfig = {
      apiKey: "AIzaSyBXCXAB2n2qqF6lIxpX5XYnqBWHClYik14",
      authDomain: "stpatricksprogresscard.firebaseapp.com",
      projectId: "stpatricksprogresscard",
      storageBucket: "stpatricksprogresscard.appspot.com",
      messagingSenderId: "671416933178",
      appId: "1:671416933178:web:4921d57abc6eb11bd2ce03"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const db = firebase.firestore();

    const loginRoot = document.getElementById('login-root');

    function showLoginUI() {
      if (!loginRoot) return;
      loginRoot.innerHTML = `
        <div class="login-box">
          <div style="font-weight:bold; color:#0f3d6b; font-size:1.3em; text-align:center; margin-bottom:6px;">
            Login to Your School Account
          </div>
          <input type="email" id="email" placeholder="Email" autocomplete="username">
          <input type="password" id="password" placeholder="Password" autocomplete="current-password">
          <button class="btn-email" onclick="emailSignIn()">Sign in</button>
          <div style="text-align:center;margin-top:8px;">
          <a href="#" onclick="openResetModal()" style="color:#1762a7;text-decoration:none;font-weight:600;">Forgot password?</a>
        </div>
        </div>
      `;
      loginRoot.style.display = 'flex';
    }

    window.emailSignIn = function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) return alert('Enter email and password!');
      auth.signInWithEmailAndPassword(email, password)
        .then(async userCred => {
  const email = (userCred.user.email || '').trim().toLowerCase();
  const snap = await db.collection('users').where('email', '==', email).get();

  if (snap.empty) throw new Error("User profile not found in Firestore.");

  if (snap.size > 1) {
    // If same email is used for multiple schools, pick the first for now
    console.warn("Multiple user docs for this email; using the first.");
  }
  const userDoc = snap.docs[0];
  const userData = userDoc.data();
  localStorage.setItem("userData", JSON.stringify(userData));

  const schoolDoc = await db.collection('schools').doc(userData.schoolId).get();
  if (!schoolDoc.exists) throw new Error("School info not found!");
  const schoolData = schoolDoc.data();
  localStorage.setItem("schoolData", JSON.stringify(schoolData));
  window.location.href = "dashboard.html";
})
        .then(schoolDoc => {
          if (!schoolDoc.exists) throw new Error("School info not found!");
          const schoolData = schoolDoc.data();
          localStorage.setItem("schoolData", JSON.stringify(schoolData));
          // 3. Go to dashboard
          window.location.href = "dashboard.html";
        })
        .catch(err => {
          let msg = err.message;
          if (msg.includes('no user')) msg = "No such account.";
          if (msg.includes('password is invalid')) msg = "Incorrect password.";
          alert(msg);
        });
    };

    auth.onAuthStateChanged(function (user) {
  if (user) {
    // If already logged in, check localStorage and redirect
    const cachedUser = localStorage.getItem("userData");
    const cachedSchool = localStorage.getItem("schoolData");
    if (cachedUser && cachedSchool) {
      window.location.replace("dashboard.html");
      return;
    }

    // Fresh fetch by EMAIL (not doc(uid))
    (async () => {
      const email = (user.email || '').trim().toLowerCase();
      const snap = await db.collection('users').where('email', '==', email).get();
      if (snap.empty) throw new Error("User profile not found in Firestore.");

      const userDoc = snap.docs[0];
      const userData = userDoc.data();
      localStorage.setItem("userData", JSON.stringify(userData));

      const schoolDoc = await db.collection('schools').doc(userData.schoolId).get();
      if (!schoolDoc.exists) throw new Error("School info not found!");
      const schoolData = schoolDoc.data();
      localStorage.setItem("schoolData", JSON.stringify(schoolData));

      window.location.replace("dashboard.html");
    })().catch((e) => {
      console.warn(e);
      showLoginUI();
    });

  } else {
    showLoginUI();
  }
});
    // --- Forgot Password via Phone OTP ---
const functions = firebase.app().functions('us-central1');

let _appVerifier = null;
let _confirmationResult = null;

window.openResetModal = function() {
  const m = document.getElementById('reset-modal');
  if (!m) return;
  m.style.display = 'flex';
  setupRecaptcha();
};

window.closeResetModal = function() {
  const m = document.getElementById('reset-modal');
  if (!m) return;
  m.style.display = 'none';
  _appVerifier = null;
  _confirmationResult = null;

  const clear = id => { const el = document.getElementById(id); if (el) el.value = ''; };
  clear('rp-phone'); clear('rp-otp'); clear('rp-newpass');

  const otpArea = document.getElementById('rp-otp-area');
  if (otpArea) otpArea.style.display = 'none';
};

function setupRecaptcha() {
  const container = document.getElementById('recaptcha-container');
  if (!container) return;
  container.innerHTML = '';
  _appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'normal' });
  _appVerifier.render();
}

window.startPhoneReset = async function() {
  try {
    let phone = (document.getElementById('rp-phone')?.value || '').trim();
    phone = phone.replace(/\s+/g, '');

    // If user typed exactly 10 digits, assume India and prepend +91
    if (/^\d{10}$/.test(phone)) phone = '+91' + phone;

    // Final check: must be + and 10-15 digits
    if (!/^\+\d{10,15}$/.test(phone)) {
      return alert('Enter phone in international format, e.g., +91XXXXXXXXXX');
    }

    if (!_appVerifier) setupRecaptcha();
    _confirmationResult = await auth.signInWithPhoneNumber(phone, _appVerifier);

    const area = document.getElementById('rp-otp-area');
    if (area) area.style.display = 'block';
    alert('OTP sent to your phone.');
  } catch (e) {
    alert(e.message || 'Failed to send OTP.');
  }
};

window.verifyOtpAndSetPassword = async function() {
  try {
    const otp = (document.getElementById('rp-otp')?.value || '').trim();
    const newPass = (document.getElementById('rp-newpass')?.value || '').trim();
    const phone = (document.getElementById('rp-phone')?.value || '').trim();

    if (!otp) return alert('Enter OTP.');
    if (!newPass) return alert('Enter new password.');
    if (!_confirmationResult) return alert('Send OTP first.');

    // Confirm OTP -> temporary phone-auth session
    const result = await _confirmationResult.confirm(otp);
    const phoneUser = result.user; // not used further, but proves verification

    // Call Cloud Function to update the real account password
   // No phone sent — server will read from verified OTP session
const callable = functions.httpsCallable('resetPasswordWithPhone');
const emailHint = (document.getElementById('rp-email')?.value || '').trim();
const resp = await callable({ newPassword: newPass, email: emailHint });

await auth.signOut();
localStorage.removeItem('userData');
localStorage.removeItem('schoolData');

const updatedEmail = resp?.data?.targetEmail || '(unknown email)';
alert(`Password updated for: ${updatedEmail}\nNow sign in with this email and your new password.`);
closeResetModal();
  } catch (e) {
  // If backend sent candidates, show them so you can pick and retry
  const details = e?.details;
  if (details?.candidates?.length) {
    alert(`Multiple accounts share this phone.\nEnter one of these emails in the Email box and try again:\n\n${details.candidates.join('\n')}`);
    return;
  }
  alert(e?.message || 'Failed to verify or update password.');
}
};
  </script>
  <!-- Reset Password Modal -->
<div id="reset-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#00000066;z-index:2000;">
  <div style="width:92vw;max-width:380px;background:#fff;border-radius:16px;box-shadow:0 10px 28px #0f3d6b22;padding:18px 16px;">
    <div style="font-weight:700;color:#0f3d6b;font-size:1.2em;text-align:center;margin-bottom:6px;">Reset Password</div>
    <div style="font-size:.92em;color:#335;opacity:.9;text-align:center;margin-bottom:12px;">Verify your phone to set a new password</div>

    <input id="rp-phone" type="tel" placeholder="Registered phone (e.g., +91XXXXXXXXXX)" style="width:100%;padding:10px 12px;font-size:1.02em;border:1.2px solid #bcd6ef;border-radius:8px;background:#f7fafd;margin-bottom:8px;">

    <input id="rp-email" type="email" placeholder="Account email (only if multiple accounts use this phone)" style="width:100%;padding:10px 12px;font-size:1.02em;border:1.2px solid #bcd6ef;border-radius:8px;background:#f7fafd;margin-bottom:8px;">

    <div id="recaptcha-container" style="margin:10px 0;"></div>
    
    <button id="rp-sendotp" onclick="startPhoneReset()" class="btn-email" style="width:100%;">Send OTP</button>

    <div id="rp-otp-area" style="display:none;margin-top:10px;">
      <input id="rp-otp" type="text" placeholder="Enter OTP" style="width:100%;padding:10px 12px;font-size:1.02em;border:1.2px solid #bcd6ef;border-radius:8px;background:#f7fafd;margin-bottom:8px;">
      <input id="rp-newpass" type="password" placeholder="New password" style="width:100%;padding:10px 12px;font-size:1.02em;border:1.2px solid #bcd6ef;border-radius:8px;background:#f7fafd;margin-bottom:8px;">
      <button id="rp-verify" onclick="verifyOtpAndSetPassword()" class="btn-email" style="width:100%;">Verify & Update</button>
    </div>

    <div style="text-align:center;margin-top:10px;">
      <button onclick="closeResetModal()" style="background:none;border:none;color:#1762a7;font-weight:600;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>
  <style>
  #cc-alert {
    position: fixed; inset: 0; display: none;
    align-items: center; justify-content: center;
    background: #00000066; z-index: 3000;
  }
  #cc-alert .box {
    width: 92vw; max-width: 360px; background: #fff;
    border-radius: 14px; box-shadow: 0 10px 28px #0f3d6b22;
    padding: 16px;
  }
  #cc-alert .title { font-weight: 800; color: #0f3d6b; font-size: 1.05em; margin-bottom: 8px; }
  #cc-alert .msg { color: #223; margin-bottom: 12px; white-space: pre-wrap; }
  #cc-alert .ok {
    width: 100%; padding: 10px; border: none; border-radius: 8px;
    background: #1762a7; color: #fff; font-weight: 700; cursor: pointer;
  }
</style>

<div id="cc-alert" role="dialog" aria-modal="true" aria-labelledby="cc-alert-title">
  <div class="box">
    <div id="cc-alert-title" class="title">CampusConnect</div>
    <div id="cc-alert-msg" class="msg"></div>
    <button class="ok" onclick="closeCcAlert()">OK</button>
  </div>
</div>

<script>
  function ccAlert(message, title = 'CampusConnect') {
    document.getElementById('cc-alert-title').textContent = title;
    document.getElementById('cc-alert-msg').textContent = String(message ?? '');
    document.getElementById('cc-alert').style.display = 'flex';
  }
  function closeCcAlert() {
    document.getElementById('cc-alert').style.display = 'none';
  }
  // Optional: replace native alert everywhere
  window.alert = (msg) => ccAlert(msg);
</script>
</body>
</html>



