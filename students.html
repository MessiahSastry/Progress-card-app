<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Students – CampusConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    html, body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f8fc; min-height: 100vh; min-width: 100vw; overflow-x: hidden; }
    .fixed-header {
  background: #0f3d6b; 
  color: #fff; 
  text-align: center; 
  padding: 18px 0 8px 0; 
  border-bottom-left-radius: 14px; 
  border-bottom-right-radius: 14px; 
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  width: 100%;
}
    .fixed-header .school-title { color: #fff; font-size: 1.5em; margin: 0; }
    .fixed-header .subtitle { color: #c9e4ff; font-size: .99em; font-weight: 400; margin: 0; }
    .fixed-header #header-exam { font-size: 1.13em; font-weight: bold; color: #fdc600; margin: 6px 0 0 0; }
    .main-content { 
      padding: 18px 10px 80px 10px; 
      max-width: 510px; 
      margin: 0 auto; 
      min-height: 60vh; 
      margin-top: 88px;  /* <-- adjust to your header height (try 70px, 80px, 90px as needed) */
    }
    .screen-title { font-size: 1.4em; font-weight: bold; text-align: left; color: #0f3d6b; margin-bottom: 12px; margin-top: 18px; letter-spacing: 0.5px; }
    .student-list { display: flex; flex-direction: column; gap: 7px; margin-top: 14px; }
    .student-row { background: #fff; border-radius: 12px; padding: 10px 16px; margin-bottom: 0px; box-shadow: 0 1px 5px #0f3d6b15; font-size: 1.09em; font-weight: 500; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; transition: box-shadow .13s; }
    .student-row:hover { box-shadow: 0 2px 10px #0f3d6b25; background: #f7fafd; }
    .roll-no { display: inline-block; min-width: 30px; font-weight: bold; color: #1467b7; }
    .student-faded { color: #999; font-size: 0.96em; margin-left: 10px; }
    .deleted-student { text-decoration: line-through; opacity: 0.5; }
    .fab, .settings-btn { position: fixed; right: 22px; width: 44px; height: 44px; border-radius: 50%; background: #0f3d6b; box-shadow: 0 4px 18px #0f3d6b30; display: flex; align-items: center; justify-content: center; z-index: 104; border: none; cursor: pointer; transition: background 0.18s, box-shadow 0.18s; color: #fff; font-size: 1.75em; }
    .fab { bottom: 30px; }
    .fab:active, .settings-btn:active { background: #195084; box-shadow: 0 2px 8px #0f3d6b44; }
    .fab::before { content: "+"; display: block; font-size: 1.1em; font-weight: bold; color: #fff; line-height: 1; text-align: center; }
    .settings-btn { bottom: 86px; }
    .settings-btn i { color: #fff !important; font-size: 0.95em; pointer-events: none; margin: 0; padding: 0; }
    #popup-bg { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: #0007; z-index: 2001; display: none; align-items: center; justify-content: center; }
    #popup-bg.show { display: flex !important; }
    #popup-content {
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 8px 30px #0f3d6b22;
  padding: 22px 18px 18px 18px;
  min-width: 270px;
  max-width: 94vw;
  width: 350px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: stretch;

  /* make the popup scroll if content is tall */
  max-height: 85vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
    .popup-title { font-size: 1.13em; color: #0f3d6b; font-weight: 700; margin-bottom: 9px; }
    #popup-content label { font-weight: 600; color: #195084; margin-bottom: 4px; }
    #popup-content input, #popup-content select { padding: 9px 11px; font-size: 1.07em; border-radius: 7px; border: 1.3px solid #c7d7ea; background: #f7fafd; margin-bottom: 13px; transition: border-color .2s; }
    #popup-content input:focus, #popup-content select:focus { outline: none; border-color: #0f3d6b; }
    .popup-btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
    .popup-cancel-btn { background: #e0e0e0; color: #444; font-weight: 500; border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer; transition: background .14s; }
    .popup-action-btn { background: #0f3d6b; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: bold; cursor: pointer; transition: background .14s; }
    .popup-action-btn:hover { background: #195084; }
    .wa-btn { background: #25D366; color: #fff; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; padding: 7px 10px; margin-left: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
    .wa-btn i { font-size: 1.1em; }
    .wa-btn:active { background: #189d44; }
    #popup-content label,
    #popup-content input,
    #popup-content .popup-btn-row {
      display: block !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    #popup-content input {
      margin-bottom: 13px !important;
    }
   .custom-dropdown {
  border: 1.4px solid #1467b7;
  border-radius: 7px;
  background: #f7fafd;
  margin-bottom: 15px;
  width: 100%;
  position: relative;
  font-size: 1.09em;
}

.dropdown-selected {
  padding: 13px 14px;
  cursor: pointer;
  user-select: none;
  border-radius: 7px;
}

.dropdown-list {
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: #fff;
  border: 1.2px solid #1467b7;
  border-top: none;
  border-radius: 0 0 7px 7px;
  box-shadow: 0 8px 24px #1467b720;
  z-index: 9;
  max-height: 200px;
  overflow-y: auto;
}

.dropdown-option {
  padding: 13px 14px;
  cursor: pointer;
}

.dropdown-option:hover {
  background: #e3f2fd;
}

.dropdown-selected.disabled {
  color: #b6b6b6 !important;
  background: #f0f0f0 !important;
  pointer-events: none;
}
    .att-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  border-bottom: 1px solid #f2f2f2;
  padding: 10px 0 4px 0;
}
.att-main {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}
.att-name {
  font-weight: 600;
  color: #222;
  font-size: 1em;
  min-width: 110px;
  max-width: 170px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.att-badges {
  display: flex;
  gap: 10px;
  margin-top: 2px;
}
.att-badge {
  padding: 2px 13px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1em;
  display: inline-block;
  border: 1.3px solid #e0e0e0;
}
.att-m-present, .att-a-present { background: #eaf8ea; color: #208c2c; border: 1px solid #70d085;}
.att-m-absent,  .att-a-absent  { background: #fae9e9; color: #d43f3a; border: 1px solid #e48a8a;}
.att-total-box {
  border: 1.5px solid #1762a7;
  border-radius: 8px;
  padding: 5px 18px;
  min-width: 60px;
  font-size: 1.09em;
  background: #f8fcfe;
  text-align: center;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.marks-row {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #f3f3f3;
  padding: 10px 0;
  width: 100%;
}
.roll-name {
  flex: 1;
  min-width: 0;
  color: #1762a7;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 1.08em;
}
.marks-input {
  width: 48px;
  max-width: 55px;
  font-size: 1.13em;
  padding: 4px 5px;
  border-radius: 7px;
  border: 1px solid #bbb;
  background: #f7fafd;
  text-align: right;
  margin-left: 10px;
}
    .call-icon:hover {
  color: #218c53 !important;
  text-decoration: none !important;
}
   /* Photo UI inside Add/Edit popups */
.photo-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.photo-preview {
  width: 68px; height: 68px; border-radius: 50%;
  background: #e7f1fb; display:flex; align-items:center; justify-content:center;
  color:#0f3d6b; font-weight:700; overflow:hidden; box-shadow: 0 0 0 2px #e9f2fb;
}
.photo-preview img { width: 100%; height: 100%; object-fit: cover; display:block; }

.photo-actions { display: flex; flex-direction: column; gap: 6px; }
.photo-actions .mini { padding: 6px 10px; border-radius: 7px; border:none; font-weight:600; cursor:pointer; }
.photo-actions .mini.take { background:#1762a7; color:#fff; }
.photo-actions .mini.upload { background:#2ba84a; color:#fff; }
.photo-actions .mini.remove { background:#eee; color:#444; }
  /* small avatar in student list */
.stu-avatar{
  width:34px;height:34px;border-radius:50%;
  overflow:hidden;display:inline-flex;align-items:center;justify-content:center;
  background:#e7f1fb;color:#0f3d6b;font-weight:700;margin:0 10px 0 6px;
  box-shadow:0 0 0 2px #e9f2fb;
}
.stu-avatar img{width:100%;height:100%;object-fit:cover;display:block}

  </style>
</head>
<body>
  <div class="fixed-header" id="header">
  <div class="school-title" id="school-title"></div>
  <div class="subtitle" id="header-subtitle"></div>
  <div class="subtitle" id="header-exam" style="font-weight:600;"></div>
</div>
  <div class="main-content" id="main-area"></div>
  <button class="fab" id="fab"></button>
  <button class="settings-btn" id="settings-btn" title="Settings"><i class="fa fa-cog"></i></button>
  <div id="popup-bg"><div id="popup-content"></div></div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    function normalizeExamName(name) {
   return name.replace(/[\s\.\-]/g, '').toUpperCase();
}
    // ======================= CONFIG ==============================
   // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBXCXAB2n2qqF6lIxpX5XYnqBWHClYik14",
      authDomain: "stpatricksprogresscard.firebaseapp.com",
      projectId: "stpatricksprogresscard",
      storageBucket: "stpatricksprogresscard.firebasestorage.app",
      messagingSenderId: "671416933178",
      appId: "1:671416933178:web:4921d57abc6eb11bd2ce03"
    };
     firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
// ---- helpers (GLOBAL, single copy) ----
function toRoll(n) {
  const r = parseInt(n, 10);
  return (isNaN(r) || r < 1 || r > 999) ? null : r;
}
function normalizePhone(p) {
  let s = String(p ?? '').replace(/\D/g, '').replace(/^0+/, '');
  if (s.startsWith('91') && s.length === 12) s = s.slice(2);
  return s;
}
function isValidPhone(s) {
  return /^\d{10,12}$/.test(String(s || ''));
}

// --- NEW: initials for avatar placeholders ---
function getInitials(name) {
  const parts = String(name || '').trim().toUpperCase().split(/\s+/).filter(Boolean);
  const first = parts[0]?.[0] || '';
  const last  = parts.length > 1 ? parts[parts.length - 1][0] : '';
  return (first + last) || '?';
}

// --- NEW: crop center-square, resize, compress to JPEG ---
async function processImageFile(file, size = 512, quality = 0.85) {
  if (!file || !/^image\//i.test(file.type)) {
    throw new Error('Not an image file');
  }
  const dataUrl = await readFileAsDataURL(file);
  const img = await loadImage(dataUrl);

  const srcW = img.naturalWidth || img.width;
  const srcH = img.naturalHeight || img.height;
  const side = Math.min(srcW, srcH);
  const sx = Math.floor((srcW - side) / 2);
  const sy = Math.floor((srcH - side) / 2);

  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, sx, sy, side, side, 0, 0, size, size);

  const outDataUrl = canvas.toDataURL('image/jpeg', quality);
  const blob = await new Promise((resolve) => {
    canvas.toBlob((b) => resolve(b || dataURItoBlob(outDataUrl)), 'image/jpeg', quality);
  });
  return { blob, dataUrl: outDataUrl };
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

function dataURItoBlob(dataURI) {
  const byteString = atob(String(dataURI).split(',')[1] || '');
  const mimeString = (String(dataURI).split(',')[0] || '').split(':')[1]?.split(';')[0] || 'image/jpeg';
  const ab = new ArrayBuffer(byteString.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
  return new Blob([ab], { type: mimeString });
}
// —— multi-school context from dashboard/sections ——
let schoolData = {};
try { schoolData = JSON.parse(localStorage.getItem('schoolData') || '{}'); } catch {}
const schoolId = schoolData.schoolId;
if (!schoolId) {
  alert('School not set. Please sign in again.');
  window.location.replace('index.html');
}

// Header + document title
const schoolTitleEl = document.getElementById('school-title');
const headerSubtitleEl = document.getElementById('header-subtitle');
if (schoolTitleEl) schoolTitleEl.textContent = schoolData.name || 'School Name';
if (headerSubtitleEl) headerSubtitleEl.textContent = schoolData.subtitle || 'CampusConnect';
document.title = schoolData?.name ? `Students – ${schoolData.name}` : 'Students – CampusConnect';
const CLASS_GROUP_MAP = {
  'Nursery': 'nursery-lkg-ukg',
  'LKG': 'nursery-lkg-ukg',
  'UKG': 'nursery-lkg-ukg',
  '1st Class': 'class-1-2',
  '2nd Class': 'class-1-2',
  '3rd Class': 'class-3-5',
  '4th Class': 'class-3-5',
  '5th Class': 'class-3-5',
  '6th Class': 'class-6-9',
  '7th Class': 'class-6-9',
  '8th Class': 'class-6-9',
  '9th Class': 'class-6-9',
  '10th Class': 'class-10'
};

function getClassGroupName(className) {
  return CLASS_GROUP_MAP[className] || 'default';
}
      function formatDate(dateStr) {
        // Converts "YYYY-MM-DD" to "DD-MM-YYYY"
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
      }
      // ======================= GLOBALS =============================
    let academicYear = localStorage.getItem('sp_selectedYear') || '';
    const schoolName = schoolData.name || 'School'; // reuse the one defined earlier
      console.log('academicYear raw:', academicYear, 'length:', academicYear.length);
      document.getElementById('header-exam').textContent = academicYear;
      const mainArea = document.getElementById("main-area");
      const popupBg = document.getElementById('popup-bg');
      const popupContent = document.getElementById('popup-content');
      const fab = document.getElementById('fab');
      const settingsBtn = document.getElementById('settings-btn');
      let currentClassId = localStorage.getItem('sp_selectedClassId') || '';
      let currentClassName = localStorage.getItem('sp_selectedClassName') || '';
      let currentSectionId = localStorage.getItem('sp_selectedSectionId') || '';
      let currentSectionName = localStorage.getItem('sp_selectedSectionName') || '';
      
      // --- Only render UI after authentication ---
      let isAdmin = false;
    let signedInUser = null;
    auth.onAuthStateChanged(function(user) {
      if (user) {
        signedInUser = user;
        isAdmin = ["messiah.sastry@stpatricksschool.com","messiahsastry@yahoo.com"]
        .includes((user.email || "").toLowerCase());
        fab.onclick = showAddStudentPopup;
        fab.style.display = "flex";
        settingsBtn.onclick = showSettingsPopup;
        settingsBtn.style.display = "flex";
        renderStudentList();
      } else {
        window.location.replace("index.html"); // redirect to login if not authenticated
      }
    });

    // ======================= MAIN LIST ===========================
    function renderStudentList() {
  if (!currentClassId || !currentSectionId) {
    mainArea.innerHTML = `<div style="color:#e74c3c; margin-top:40px;">Error: Class or Section not selected.</div>`;
    fab.style.display = "none";
    settingsBtn.style.display = "none";
    return;
  }
  const classGroup = getClassGroupName(currentClassName);
  db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('students')
    .orderBy('roll')
    .get()
    .then(snap => {
      let students = [];
      snap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
      let html = `<div class="screen-title">${currentClassName} – ${currentSectionName}</div>
        <div class="student-list">`;
      if (students.length === 0) html += `<div style="color:#888;font-style:italic;">No students found.</div>`;
      students.filter(stu => !stu.isDeleted).forEach(stu => {
  const initials = getInitials(stu.name || '');
const avatar = stu.photoUrl
  ? `<span class="stu-avatar"><img src="${stu.photoUrl}" alt="${initials}"></span>`
  : `<span class="stu-avatar">${initials}</span>`;

html += `<div class="student-row" data-student-id="${stu.id}">
  <span class="roll-no">${stu.roll ? stu.roll + '.' : ''}</span>
  ${avatar}
  <span style="color:#1467b7; font-weight:600;">${(stu.name || '').toUpperCase()}</span>
  <span style="flex:1"></span>
  ${
    stu.parentPhone
      ? `<a href="tel:${stu.parentPhone.replace(/\D/g, '')}" class="call-icon" title="Call Parent" style="margin-left:14px;color:#27ae60; font-size:1.17em;display:flex;align-items:center;justify-content:center;"><i class="fa fa-phone"></i></a>`
      : `<i class="fa fa-phone" style="margin-left:14px;color:#bcbcbc;opacity:0.6; font-size:1.13em;" title="No phone number"></i>`
  }
</div>`;
});
      html += "</div>";
      mainArea.innerHTML = html;

      document.querySelectorAll('.student-row').forEach(row => {
        let pressTimer = null;
        row.addEventListener('mousedown', startPress);
        row.addEventListener('touchstart', startPress);
        row.addEventListener('mouseup', clearPress);
        row.addEventListener('mouseleave', clearPress);
        row.addEventListener('touchend', clearPress);

        function startPress(e) {
          pressTimer = setTimeout(() => {
            showStudentActionPopup(row.dataset.studentId);
          }, 600);
        }
        function clearPress(e) {
          clearTimeout(pressTimer);
        }
      });
    });
}
    // ===================== POPUP BASE ===========================
    function showPopup(htmlContent, formId = null, formSubmitHandler = null) {
      popupContent.innerHTML = htmlContent;
      popupBg.classList.add('show');
      popupBg.onclick = function(e) {
        if (e.target === popupBg) closePopup();
      };
      if (formId && formSubmitHandler) {
        const form = document.getElementById(formId);
        if (form) form.addEventListener('submit', formSubmitHandler);
      }
      popupContent.querySelectorAll('.popup-cancel-btn').forEach(btn => {
        btn.onclick = function(e) { e.preventDefault(); closePopup(); };
      });
    }
    function closePopup() {
      popupBg.classList.remove("show");
      popupContent.innerHTML = '';
      popupBg.onclick = null;
    }
  
    // =========== ADD/EDIT STUDENT POPUP =========================
   function showAddStudentPopup() {
  showPopup(`
    <form id="addStudentForm">
      <div class="popup-title">Add Student</div>

      <label>Student Name</label>
      <input name="studentName" style="text-transform:uppercase" maxlength="40" required>

      <label>Father's Name</label>
      <input name="fatherName" style="text-transform:uppercase" maxlength="40" required>

      <label>Roll Number</label>
      <input name="rollNo" type="number" min="1" max="999" required>

      <label>Parent Phone Number</label>
      <input name="parentPhone" type="tel" maxlength="12" required placeholder="e.g., 9876543210" pattern="[0-9]{10,12}">

      <label>Photo (optional)</label>
      <div class="photo-row">
        <div class="photo-preview" id="addPhotoPreview">${getInitials('')}</div>
        <div class="photo-actions">
          <button type="button" class="mini take" id="btnTakePhoto">Take photo</button>
          <button type="button" class="mini upload" id="btnUploadPhoto">Upload photo</button>
          <button type="button" class="mini remove" id="btnRemovePhoto" style="display:none;">Remove photo</button>

          <!-- hidden inputs for camera / file -->
          <input type="file" id="inputCamera" accept="image/*" capture="environment" style="display:none;" />
          <input type="file" id="inputFile" accept="image/*" style="display:none;" />
        </div>
      </div>

      <div class="popup-btn-row">
        <button type="button" class="popup-cancel-btn">Cancel</button>
        <button type="submit" class="popup-action-btn">Add</button>
      </div>
    </form>
  `, 'addStudentForm', async function (e) {
    e.preventDefault();

    const name = e.target.studentName.value.trim().toUpperCase();
    const father = e.target.fatherName.value.trim().toUpperCase();
    const roll = toRoll(e.target.rollNo.value);
    let parentPhone = normalizePhone(e.target.parentPhone.value);

    if (!name || !father || roll === null) {
      alert('Please enter a valid name, father name and roll (1–999).');
      return;
    }
    if (!isValidPhone(parentPhone)) {
      alert('Please enter a valid 10–12 digit parent phone number.');
      return;
    }

    // 1) Create the student first (without photo)
    const docRef = await db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(currentClassId)
      .collection('sections').doc(currentSectionId)
      .collection('students')
      .add({ name, father, roll, parentPhone });

    // 2) If a photo is selected, upload to Storage and save URL in Firestore
    if (window.__addPhotoBlob) {
      try {
        const path = `schools/${schoolId}/years/${academicYear}/classes/${currentClassId}/sections/${currentSectionId}/students/${docRef.id}/profile.jpg`;
        const ref = storage.ref().child(path);

        await ref.put(window.__addPhotoBlob, {
          contentType: 'image/jpeg',
          cacheControl: 'public,max-age=31536000'
        });

        const url = await ref.getDownloadURL();
        await docRef.update({ photoUrl: url, photoPath: path });
      } catch (err) {
        console.error('Photo upload failed:', err);
        alert('Student saved, but photo upload failed.');
      }
    }

    closePopup();
    renderStudentList();
  });

  // --- Photo controls (scoped to this popup) ---
  window.__addPhotoBlob = null;
  const prev   = document.getElementById('addPhotoPreview');
  const btnCam = document.getElementById('btnTakePhoto');
  const btnUp  = document.getElementById('btnUploadPhoto');
  const btnRem = document.getElementById('btnRemovePhoto');
  const inputCam  = document.getElementById('inputCamera');
  const inputFile = document.getElementById('inputFile');

  function showPreviewFromDataUrl(dataUrl){
  prev.innerHTML = '';
  const img = document.createElement('img');
  img.src = dataUrl;
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  img.style.borderRadius = '50%';
  img.style.display = 'block';
  prev.appendChild(img);
  btnRem.style.display = 'inline-block';
}

  async function handleFile(file){
    if (!file) return;
    // crop + resize + compress to jpeg (512x512)
    const { blob, dataUrl } = await processImageFile(file, 512, 0.85);
    window.__addPhotoBlob = blob;
    showPreviewFromDataUrl(dataUrl);
  }

  btnCam.onclick       = () => inputCam.click();
  btnUp.onclick        = () => inputFile.click();
  inputCam.onchange    = (e) => handleFile(e.target.files && e.target.files[0]);
  inputFile.onchange   = (e) => handleFile(e.target.files && e.target.files[0]);
  btnRem.onclick       = () => {
    window.__addPhotoBlob = null;
    prev.textContent = getInitials('');
    btnRem.style.display = 'none';
  };
}
   function showStudentActionPopup(studentId) {
  (async () => {
    const ref = db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(currentClassId)
      .collection('sections').doc(currentSectionId)
      .collection('students').doc(studentId);

    const snap = await ref.get();
    if (!snap.exists) { alert('Student not found.'); return; }
    const stu = snap.data() || {};

    const initials = getInitials(stu.name || '');
    const avatar = stu.photoUrl
      ? `<img src="${stu.photoUrl}" alt="${initials}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #0f3d6b;">`
      : `<span style="width:48px;height:48px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#0f3d6b;color:#fff;font-weight:700;">${initials}</span>`;

    showPopup(`
      <div class="popup-title">Student Options</div>

      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        ${avatar}
        <div style="min-width:0;">
          <div style="font-weight:700;color:#0f3d6b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${stu.roll ? (stu.roll + '. ') : ''}${stu.name || ''}
          </div>
          <div style="color:#666;font-size:.95em;">Father: ${stu.father || '-'}</div>
          <div style="color:#666;font-size:.9em;">Phone: ${stu.parentPhone || '-'}</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <button type="button" class="popup-action-btn" id="editStudentBtn">Edit Student</button>
        ${!stu.isDeleted
          ? `<button type="button" class="popup-action-btn" id="deleteStudentBtn" style="background:#d43f3a;">Delete Student</button>`
          : `<button type="button" class="popup-action-btn" id="restoreStudentBtn">Restore Student</button>`
        }
      </div>

      <div class="popup-btn-row" style="margin-top:10px;">
        <button type="button" class="popup-cancel-btn">Close</button>
      </div>
    `);

    // Wire actions after popup mounts
    setTimeout(() => {
      const editBtn    = document.getElementById('editStudentBtn');
      const deleteBtn  = document.getElementById('deleteStudentBtn');
      const restoreBtn = document.getElementById('restoreStudentBtn');

      if (editBtn) {
        editBtn.onclick = () => {
          closePopup();
          showEditStudentPopup(studentId, stu);
        };
      }

      if (deleteBtn) {
        deleteBtn.onclick = async () => {
          await ref.update({ isDeleted: true });
          closePopup();
          renderStudentList();
        };
      }

      if (restoreBtn) {
        restoreBtn.onclick = async () => {
          await ref.update({ isDeleted: firebase.firestore.FieldValue.delete() });
          closePopup();
          renderStudentList();
        };
      }
    }, 0);
  })();
}
    function showEditStudentPopup(studentId, stu) {
  showPopup(`
    <form id="editStudentForm">
      <div class="popup-title">Edit Student</div>

      <label>Student Name</label>
      <input name="studentName" maxlength="40" required value="${stu.name}">

      <label>Father's Name</label>
      <input name="fatherName" maxlength="40" required value="${stu.father}">

      <label>Roll Number</label>
      <input name="rollNo" type="number" min="1" max="999" required value="${stu.roll}">

      <label>Parent Phone Number</label>
      <input name="parentPhone" type="tel" maxlength="12" required placeholder="e.g., 9876543210" pattern="[0-9]{10,12}" value="${stu.parentPhone || ''}">
      <label>Photo (optional)</label>
      <div class="photo-row">
        <div class="photo-preview" id="editPhotoPreview">${stu.photoUrl ? '' : getInitials(stu.name || '')}</div>
        <div class="photo-actions">
          <button type="button" class="mini take" id="btnEditTakePhoto">Take photo</button>
          <button type="button" class="mini upload" id="btnEditUploadPhoto">Upload photo</button>
          <button type="button" class="mini remove" id="btnEditRemovePhoto" style="${stu.photoUrl ? '' : 'display:none;'}">${stu.photoUrl ? 'Remove current photo' : 'Remove photo'}</button>

          <!-- hidden inputs for camera / file -->
          <input type="file" id="inputEditCamera" accept="image/*" capture="environment" style="display:none;" />
          <input type="file" id="inputEditFile" accept="image/*" style="display:none;" />
        </div>
      </div>

      <div class="popup-btn-row">
        <button type="button" class="popup-cancel-btn">Cancel</button>
        <button type="submit" class="popup-action-btn">Update</button>
      </div>
    </form>
  `, 'editStudentForm', async function (e) {
    e.preventDefault();

    const name = e.target.studentName.value.trim().toUpperCase();
    const father = e.target.fatherName.value.trim().toUpperCase();
    const roll = toRoll(e.target.rollNo.value);
    let parentPhone = normalizePhone(e.target.parentPhone.value);

    if (!name || !father || roll === null) { alert('Please enter a valid name, father name and roll (1–999).'); return; }
    if (!isValidPhone(parentPhone)) { alert('Please enter a valid 10–12 digit parent phone number.'); return; }

    const docRef = db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(currentClassId)
      .collection('sections').doc(currentSectionId)
      .collection('students').doc(studentId);

    // Save basic fields first
    try {
      await docRef.update({ name, father, roll, parentPhone });
    } catch (err) {
      console.error(err);
      alert('Failed to save. ' + (err && err.message ? err.message : ''));
      return;
    }

    // If user chose to REMOVE photo (and did not upload a new one)
    if (window.__editRemovePhoto === true && !window.__editPhotoBlob) {
      try {
        if (stu.photoPath) {
          await storage.ref().child(stu.photoPath).delete().catch(() => {});
        }
        await docRef.update({
          photoUrl: firebase.firestore.FieldValue.delete(),
          photoPath: firebase.firestore.FieldValue.delete()
        });
      } catch (err) {
        console.error('Remove photo failed:', err);
        alert('Details saved, but photo removal failed.');
      }
    }

    // If user uploaded/took a new photo
    if (window.__editPhotoBlob) {
      try {
        const path = `schools/${schoolId}/years/${academicYear}/classes/${currentClassId}/sections/${currentSectionId}/students/${studentId}/profile.jpg`;
        const sref = storage.ref().child(path);

        await sref.put(window.__editPhotoBlob, {
          contentType: 'image/jpeg',
          cacheControl: 'public,max-age=31536000'
        });

        const url = await sref.getDownloadURL();
        await docRef.update({ photoUrl: url, photoPath: path });
      } catch (err) {
        console.error('Edit photo error:', err);
        alert('Details updated, but photo change failed. You can try again.');
      }
    }

    closePopup();
    renderStudentList();
  });

  // --- Photo controls (scoped to this popup) ---
  window.__editPhotoBlob = null;
  window.__editRemovePhoto = false;

  const prev    = document.getElementById('editPhotoPreview');
  const btnCam  = document.getElementById('btnEditTakePhoto');
  const btnUp   = document.getElementById('btnEditUploadPhoto');
  const btnRem  = document.getElementById('btnEditRemovePhoto');
  const inputCam  = document.getElementById('inputEditCamera');
  const inputFile = document.getElementById('inputEditFile');

  function showPreviewFromUrl(url) {
  if (!prev) return;
  prev.innerHTML = '';
  const img = document.createElement('img');
  img.src = url;
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  img.style.borderRadius = '50%';
  img.style.display = 'block';
  prev.appendChild(img);
}
function showPreviewFromDataUrl(dataUrl) {
  if (!prev) return;
  prev.innerHTML = '';
  const img = document.createElement('img');
  img.src = dataUrl;
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  img.style.borderRadius = '50%';
  img.style.display = 'block';
  prev.appendChild(img);
}
  function showInitials() {
    if (!prev) return;
    prev.textContent = getInitials(stu.name || '');
  }

  // Initialize preview
  if (stu.photoUrl) { showPreviewFromUrl(stu.photoUrl); }

  async function handleFile(file) {
    if (!file) return;
    const { blob, dataUrl } = await processImageFile(file, 512, 0.85);
    window.__editPhotoBlob = blob;
    window.__editRemovePhoto = false; // override remove if new picked
    showPreviewFromDataUrl(dataUrl);
    if (btnRem) btnRem.style.display = 'inline-block';
  }

  if (btnCam) btnCam.onclick = () => inputCam && inputCam.click();
  if (btnUp)  btnUp.onclick  = () => inputFile && inputFile.click();
  if (inputCam)  inputCam.onchange  = (e) => handleFile(e.target.files && e.target.files[0]);
  if (inputFile) inputFile.onchange = (e) => handleFile(e.target.files && e.target.files[0]);

  if (btnRem) {
    btnRem.onclick = () => {
      window.__editPhotoBlob = null;
      window.__editRemovePhoto = true;
      showInitials();
      btnRem.style.display = 'none';
    };
  }
}
    // ======================= SETTINGS POPUP =====================
    function showSettingsPopup() {
  showPopup(`
    <div class="popup-title">Section Tools</div>
    <div style="display:flex;flex-direction:column;gap:13px;">
      <button class="popup-action-btn" id="uploadStudentsBtn">Upload Students (Excel)</button>
      <button class="popup-action-btn" id="yearPlanBtn">Year Plan</button>
      <button class="popup-action-btn" id="examSettingsBtn">Exam Settings</button>
      <button class="popup-action-btn" id="uploadMarksBtn">Upload Marks (Excel)</button>
      <button class="popup-action-btn" id="enterMarksBtn">Enter Marks</button>
      <button class="popup-action-btn" id="attendanceBtn">Take Attendance (WhatsApp)</button>
      <button class="popup-action-btn" id="viewAttendanceBtn">View Attendance</button>
      <button class="popup-action-btn" id="absenteesPDFBtn">Absentees Report (PDF)</button>
      <button class="popup-action-btn" id="downloadMemosBtn">Download Class Marks Memos (PDF)</button>
      <button class="popup-action-btn" id="postMarksBtn">Post Marks (WhatsApp)</button>
      <button class="popup-action-btn" id="downloadHallTicketsBtn">Download Hall Tickets</button>
      <button class="popup-action-btn" id="downloadExcelBtn">Download Class Marks (Excel/Pdf)</button>
      <button class="popup-action-btn" id="performanceGraphBtn">Performance Graph</button>
      <button class="popup-action-btn" id="createCertificateBtn">Create Certificate</button>
      <button class="popup-action-btn" id="showDeletedBtn">Show Deleted Students</button>
      <button class="popup-cancel-btn">Close</button>
    </div>
  `);
  document.getElementById('uploadStudentsBtn').onclick = showBulkStudentUploadPopup;
  document.getElementById('examSettingsBtn').onclick = showExamSettingsPopup;
  document.getElementById('uploadMarksBtn').onclick = showBulkMarksUploadPopup;
  document.getElementById('enterMarksBtn').onclick = showEnterMarksPopup;
  document.getElementById('attendanceBtn').onclick = showAttendancePopup;
  document.getElementById('viewAttendanceBtn').onclick = showAttendanceHistoryPopup;
  document.getElementById('postMarksBtn').onclick = function(){ window.location.href = "post-marks.html"; };
  document.getElementById('downloadMemosBtn').onclick = function() {
    window.location.href = "memos.html";
  };
  document.getElementById('downloadHallTicketsBtn').onclick = function() {
    window.location.href = "hallticket.html";
  };
  document.getElementById('downloadExcelBtn').onclick = function() {
  window.location.href = "excel.html";
};
  document.getElementById('performanceGraphBtn').onclick = function() {
  window.location.href = "performance.html";
};
  document.getElementById('showDeletedBtn').onclick = showDeletedStudentsPopup;
      document.getElementById('createCertificateBtn').onclick = function() {
  openCertificateGenerator();
};
    document.getElementById('yearPlanBtn').onclick = function() {
    window.location.href = "year-plan.html";
};
  document.getElementById('absenteesPDFBtn').onclick = function() {
  openAbsenteesModal();
};
}
// ========== EXAM SETTINGS ===========
async function showExamSettingsPopup() {
    // read class-level permission and compute canManageExams
  const classDoc = await db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId).get();

  const cd = classDoc.exists ? (classDoc.data() || {}) : {};
  const allowExamAdd = !!cd.allowExamAdd;
  const examManagers = Array.isArray(cd.examManagers) ? cd.examManagers : [];

  const meEmail = (signedInUser?.email || '').toLowerCase();
  const meUid   = signedInUser?.uid || '';

  const normalizedManagers = examManagers.map(x => String(x || '').toLowerCase());
  const canUserFromList = normalizedManagers.includes(meEmail) || examManagers.includes(meUid);

  const canManageExams =
  isAdmin ||
  allowExamAdd ||
  canUserFromList ||
  (!('allowExamAdd' in cd) && !('examManagers' in cd)); // default allow if not configured
  const classGroup = getClassGroupName(currentClassName);
  // Fetch all exams for this group
  db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('exams')
    .get()
    .then(snap => {
      let exams = [];
      snap.forEach(doc => exams.push({ id: doc.id, ...doc.data() }));
      let html = `
        <div class="popup-title">Exam Settings</div>
        <div id="examListArea" style="max-height:240px;overflow-y:auto;margin-bottom:12px;">
          ${exams.length === 0 
            ? '<div style="color:#888;font-style:italic;">No exams found.</div>' 
            : exams.map((exam, idx) => `
                <div style="border-bottom:1px solid #f1f1f1;margin-bottom:7px;padding-bottom:7px;">
                  <strong>${exam.name}</strong>
                ${canManageExams ? `<button type="button" class="popup-action-btn" data-edit="${exam.id}">Edit</button>` : ''}
                  <div style="margin-top:6px;margin-left:8px;font-size:0.99em;">
                    ${Array.isArray(exam.subjects) && exam.subjects.length > 0
                      ? exam.subjects.map(subj => `${subj.name} <span style="color:#888;">(Max: ${subj.max})</span>`).join(', ')
                      : '<span style="color:#aaa;">No subjects</span>'
                    }
                  </div>
                </div>
              `).join('')}
        </div>
        ${canManageExams ? `
      <form id="addExamForm" style="display:flex; flex-direction:column; max-height:58vh;">
        <div style="flex:1; overflow-y:auto; padding-right:4px;">
          <label>Exam Name</label>
          <input name="examName" maxlength="30" required placeholder="e.g., FA1">
          <label>Subjects</label>
          <div id="subjectsContainer"></div>
          <button type="button" id="addSubjectBtn"
            style="margin:6px 0 14px 0; background:#1762a7;color:#fff;
                   padding:7px 13px;border:none;border-radius:7px;font-weight:600;">
            + Add Subject
          </button>
        </div>
        <div class="popup-btn-row" style="margin-top:10px;">
          <button type="button" class="popup-cancel-btn">Close</button>
          <button type="submit" class="popup-action-btn">Add Exam</button>
        </div>
      </form>
      ` : `
      <div class="popup-btn-row" style="margin-top:10px;">
        <button type="button" class="popup-cancel-btn">Close</button>
      </div>
      `}
      `;
      showPopup(html, 'addExamForm', function (e) {
        e.preventDefault();
        const name = e.target.examName.value.trim();
        const nameKey = normalizeExamName(name); // Normalize for comparison
        let subjects = [];
        const container = popupContent.querySelector('#subjectsContainer');
        if (container) {
          const subjectDivs = container.querySelectorAll('div[data-subject-row]');
          subjectDivs.forEach(div => {
            const subjInput = div.querySelector('input[type="text"]');
            const marksInput = div.querySelector('input[type="number"]');
            const subjName = subjInput ? subjInput.value.trim() : '';
            const maxMarks = marksInput ? parseInt(marksInput.value.trim()) : 0;
            if (subjName && maxMarks) {
              subjects.push({ name: subjName, max: maxMarks });
            }
          });
        }
        if (!name || !subjects.length) {
          alert("Please enter exam name and at least one subject!");
          return;
        }
        // Check for duplicates before adding
        db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
        .collection('classes').doc(currentClassId)
        .collection('exams')
        .where('nameKey', '==', nameKey)
          .get()
          .then(dupSnap => {
            if (!dupSnap.empty) {
              alert("Exam with this (or very similar) name already exists!");
              return;
            }
            // If not duplicate, add
            db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
            .collection('classes').doc(currentClassId)
            .collection('exams')
            .add({ name, nameKey, subjects })
              .then(() => { closePopup(); showExamSettingsPopup(); });
          });
      });

     // --- Subject Fields Logic (guarded if canManageExams) ---
if (canManageExams) {
  const subjectsContainer = popupContent.querySelector('#subjectsContainer');
  const addSubjectBtn = popupContent.querySelector('#addSubjectBtn');

  function addSubjectField(name = '', max = '') {
    const idx = subjectsContainer.children.length;
    const div = document.createElement('div');
    div.setAttribute("data-subject-row", "");
    div.style = "display:flex;align-items:center;gap:8px;margin-bottom:7px;";
    div.innerHTML = `
     <input type="text" name="subjectName_${idx}" placeholder="Subject Name" value="${name}" required style="width:80%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd; margin-right:7px;" />
     <input type="number" name="maxMarks_${idx}" placeholder="Max Marks" min="1" max="200" value="${max}" required style="width:25%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd;" />
     ${isAdmin ? `<button type="button" class="option-btn" style="width: 70px; padding: 5px;" onclick="this.parentNode.remove()">Remove</button>` : ''}
    `;
    subjectsContainer.appendChild(div);
  }

  addSubjectBtn.onclick = () => addSubjectField();
  addSubjectField();
}
      // Attach Edit button handlers
      setTimeout(() => {
        popupContent.querySelectorAll('[data-edit]').forEach(btn => {
          btn.onclick = function() {
            const examId = btn.getAttribute('data-edit');
            closePopup();
            showEditExamPopup(examId);
          };
        });
      }, 200);
    });
}

// ----------- EDIT EXAM -------------
async function showEditExamPopup(examId) {
  // 1) PERMISSION CHECK (admin OR class-allowed user)
  const classDoc = await db.collection('schools').doc(schoolId)
    .collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .get();

  const cd = classDoc.exists ? (classDoc.data() || {}) : {};
  const allowExamAdd  = !!cd.allowExamAdd;                                   // boolean
  const examManagers  = Array.isArray(cd.examManagers) ? cd.examManagers : []; // [emails or UIDs]

  const me = auth.currentUser;
  const meEmail = (me?.email || '').toLowerCase();
  const meUid   = me?.uid || '';
  const normalizedManagers = examManagers.map(x => String(x || '').toLowerCase());
  const canUserFromList = normalizedManagers.includes(meEmail) || examManagers.includes(meUid);

  const canManageExams = isAdmin || allowExamAdd || canUserFromList;
  if (!canManageExams) { alert('You do not have permission to edit exams.'); return; }

  // 2) LOAD THE EXAM (current storage on classGroups path)
  const classGroup = getClassGroupName(currentClassName);
  const examRef = db.collection('schools').doc(schoolId)
  .collection('years').doc(academicYear)
  .collection('classes').doc(currentClassId)
  .collection('exams')
  .doc(examId);
  const examDoc = await examRef.get();
  if (!examDoc.exists) { alert("Exam not found!"); return; }
  const exam = examDoc.data();

  // 3) UI
  showPopup(`
    <form id="editExamForm" style="display:flex; flex-direction:column; max-height:75vh;">
      <div style="flex:1; overflow-y:auto; padding-right:4px;">
        <div class="popup-title">Edit Exam</div>
        <label>Exam Name</label>
        <input name="examName" maxlength="30" required value="${exam.name}">
        <label>Subjects</label>
        <div id="editSubjectsContainer"></div>
        <button type="button" id="editAddSubjectBtn"
          style="margin:6px 0 14px 0; background:#1762a7;color:#fff;
                 padding:7px 13px;border:none;border-radius:7px;font-weight:600;">
          + Add Subject
        </button>
        <div class="popup-btn-row" style="margin-top:10px;">
          <button type="button" class="popup-cancel-btn">Cancel</button>
          <button type="submit" class="popup-action-btn">Save Changes</button>
        </div>
      </div>
    </form>
  `, 'editExamForm', function (e) {
    e.preventDefault();
    const name = e.target.examName.value.trim();
    const nameKey = normalizeExamName(name);

    let subjects = [];
    const container = popupContent.querySelector('#editSubjectsContainer');
    if (container) {
      const subjectDivs = container.querySelectorAll('div[data-subject-row]');
      subjectDivs.forEach(div => {
        const subjInput  = div.querySelector('input[type="text"]');
        const marksInput = div.querySelector('input[type="number"]');
        const subjName   = subjInput ? subjInput.value.trim() : '';
        const maxMarks   = marksInput ? parseInt(marksInput.value.trim()) : 0;
        if (subjName && maxMarks) subjects.push({ name: subjName, max: maxMarks });
      });
    }
    if (!name || !subjects.length) {
      alert("Please enter exam name and at least one subject!");
      return;
    }

    // Duplicate check (keep on classGroups path for now)
    db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
      .collection('exams')
      .where('nameKey', '==', nameKey)
      .get()
      .then(dupSnap => {
        let isDuplicate = false;
        if (!dupSnap.empty) {
          dupSnap.forEach(d => { if (d.id !== examId) isDuplicate = true; });
        }
        if (isDuplicate) { alert("Another exam with this (or very similar) name already exists!"); return; }

        // Update
        return examRef.update({ name, nameKey, subjects })
          .then(() => { closePopup(); showExamSettingsPopup(); });
      });
  });

  // 4) Subject field helpers
  const subjectsContainer = popupContent.querySelector('#editSubjectsContainer');
  const addSubjectBtn     = popupContent.querySelector('#editAddSubjectBtn');

  function addSubjectField(name = '', max = '') {
    const idx = subjectsContainer.children.length;
    const div = document.createElement('div');
    div.setAttribute("data-subject-row", "");
    div.style = "display:flex;align-items:center;gap:8px;margin-bottom:7px;";
    div.innerHTML = `
      <input type="text"   name="subjectName_${idx}" placeholder="Subject Name" value="${name}"
             required style="width:80%; padding: 8px; border-radius: 6px; border: 1.3px solid #c7d7ea; background: #f7fafd; margin-right:7px;" />
      <input type="number" name="maxMarks_${idx}"    placeholder="Max Marks" min="1" max="200" value="${max}"
             required style="width:25%; padding: 8px; border-radius: 6px; border: 1.3px solid #c7d7ea; background: #f7fafd;" />
      <button type="button" class="option-btn" style="width: 70px; padding: 5px;" onclick="this.parentNode.remove()">Remove</button>
    `;
    subjectsContainer.appendChild(div);
  }

  (Array.isArray(exam.subjects) ? exam.subjects : []).forEach(s => addSubjectField(s.name, s.max));
  addSubjectBtn.onclick = () => addSubjectField();
}

   // ============= ENTER MARKS ===============
function showEnterMarksPopup() {
  console.log('showEnterMarksPopup called');
  console.log('academicYear:', academicYear);
  const classGroup = getClassGroupName(currentClassName);
db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
  .collection('classes').doc(currentClassId)
  .collection('exams').orderBy('name').get()
    .then(examSnap => {
      let exams = [];
      examSnap.forEach(doc => exams.push({ id: doc.id, ...doc.data() }));
      if (exams.length === 0) {
        showPopup(`<div class="popup-title">Enter Marks</div>
          <div style="margin:16px 0;">No exams found! Please add exams first.</div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
        `);
        return;
      }
      let html = `
        <form id="selectExamForm">
          <div class="popup-title">Enter Marks</div>
          <label>Select Exam</label>
          <div class="custom-dropdown" id="examDropdown" tabindex="0">
            <div class="dropdown-selected" id="examSelected" data-value="">--Select--</div>
            <div class="dropdown-list" id="examList" style="display:none;"></div>
          </div>
          <label>Select Subject</label>
          <div class="custom-dropdown" id="subjectDropdown" tabindex="0">
            <div class="dropdown-selected" id="subjectSelected" data-value="">--Select Exam First--</div>
            <div class="dropdown-list" id="subjectList" style="display:none;"></div>
          </div>
          <div class="popup-btn-row">
            <button type="button" class="popup-cancel-btn">Cancel</button>
            <button type="submit" class="popup-action-btn">Next</button>
          </div>
        </form>
      `;
      showPopup(html, 'selectExamForm', function(e) {
        e.preventDefault();
        // Get selected values
        const examId = document.getElementById('examSelected').dataset.value;
        const subjectName = document.getElementById('subjectSelected').dataset.value;
        if (!examId || !subjectName) return;
        db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students').orderBy('roll').get().then(stuSnap => {
            let students = [];
            stuSnap.forEach(doc => {
              const data = doc.data();
              if (!data.isDeleted && data.isDeleted !== "true" && data.isDeleted !== 1) {
                students.push({ id: doc.id, ...data });
              }
            });
            const exam = exams.find(ex => ex.id === examId);
            const subj = (exam && exam.subjects) ? exam.subjects.find(s => s.name === subjectName) : null;
            const max = subj ? subj.max : 100;
            // --- Begin: Marks Entry Popup Block ---
            let marksData = {};
            let marksPromises = students.map(stu =>
              db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
                .collection('classes').doc(currentClassId)
                .collection('sections').doc(currentSectionId)
                .collection('students').doc(stu.id)
                .collection('marks').doc(examId)
                .get().then(doc => {
                  if (doc.exists && doc.data()[subjectName] !== undefined) {
                    marksData[stu.id] = doc.data()[subjectName];
                  }
                })
            );
            Promise.all(marksPromises).then(() => {
              let html2 = `
                <form id="marksEntryForm" style="max-height:77vh;overflow-y:auto;">
                  <div class="popup-title">Marks: ${exam.name} – ${subjectName} (Max: ${max})</div>
                  <div style="display:flex;flex-direction:column;gap:8px;">
                    ${
                      students.length === 0
                        ? '<div style="color:#888;font-style:italic;">No students found.</div>'
                        : students.map(stu => `
                      <div class="marks-row">
                      <span class="roll-name">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
                      <input
                        type="number"
                        name="marks_${stu.id}"
                        value="${marksData[stu.id] !== undefined ? marksData[stu.id] : ''}"
                        min="0" max="${max}" step="1"
                        class="marks-input"
                      />
                    </div>
                    `).join('')
                    }
                  </div>
                  <div class="popup-btn-row" style="margin-top:12px;">
                    <button type="button" class="popup-cancel-btn">Cancel</button>
                    <button type="submit" class="popup-action-btn">Save</button>
                  </div>
                </form>
              `;
              showPopup(html2, 'marksEntryForm', function(ev) {
                ev.preventDefault();
                let formData = new FormData(ev.target);
                let batch = db.batch();
                students.forEach(stu => {
  let marksStr = formData.get('marks_' + stu.id);
  let markRef = db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('students').doc(stu.id).collection('marks').doc(examId);

  if (marksStr === "" || marksStr == null) {
    // Remove the field from Firestore
    batch.set(markRef, { [subjectName]: firebase.firestore.FieldValue.delete() }, { merge: true });
  } else {
    let marks = parseFloat(marksStr);
    batch.set(markRef, { [subjectName]: marks }, { merge: true });
  }
});
                 batch.commit().then(() => {
                  alert("Marks saved successfully!");
                  closePopup();
                }).catch(error => alert("Error saving marks: " + error.message));
              });
            });
          });
      });

      // ======= Custom Dropdown Logic for Exam =======
      const examDropdown = document.getElementById('examDropdown');
      const examSelected = document.getElementById('examSelected');
      const examList = document.getElementById('examList');
      const subjectDropdown = document.getElementById('subjectDropdown');
      const subjectSelected = document.getElementById('subjectSelected');
      const subjectList = document.getElementById('subjectList');
      let selectedExam = null;

      // Populate exam dropdown
      examList.innerHTML = exams.map(e => `
        <div class="dropdown-option" data-id="${e.id}" style="padding:10px 12px;cursor:pointer;">
          ${e.name}
        </div>
      `).join('');

      // Exam show/hide
      examSelected.onclick = function () {
        examList.style.display = (examList.style.display === 'none' || examList.style.display === '') ? 'block' : 'none';
      };
      document.addEventListener('click', function handler(e) {
        if (!examDropdown.contains(e.target)) {
          examList.style.display = 'none';
          document.removeEventListener('click', handler);
        }
      });

      // Exam select logic
      examList.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.onclick = function () {
          examSelected.textContent = this.textContent;
          examSelected.dataset.value = this.dataset.id;
          examList.style.display = 'none';
          // Fill subject dropdown
          const ex = exams.find(e => e.id === this.dataset.id);
          selectedExam = ex;
          if (ex && Array.isArray(ex.subjects) && ex.subjects.length > 0) {
            subjectList.innerHTML = ex.subjects.map(s => `<div class="dropdown-option" data-name="${s.name}">${s.name} (Max: ${s.max})</div>`).join('');
            subjectSelected.textContent = '--Select--';
            subjectSelected.dataset.value = '';
            subjectSelected.classList.remove('disabled');
            subjectList.style.display = 'none';
            subjectSelected.style.pointerEvents = '';
          } else {
            subjectList.innerHTML = `<div class="dropdown-option" data-name="">No subjects</div>`;
            subjectSelected.textContent = 'No subjects';
            subjectSelected.dataset.value = '';
            subjectSelected.classList.add('disabled');
            subjectList.style.display = 'none';
            subjectSelected.style.pointerEvents = 'none';
          }
        };
      });

      // Subject show/hide
      subjectSelected.onclick = function () {
        if (!selectedExam || !selectedExam.subjects || !selectedExam.subjects.length) return;
        subjectList.style.display = (subjectList.style.display === 'none' || subjectList.style.display === '') ? 'block' : 'none';
      };
      document.addEventListener('click', function handler(e) {
        if (!subjectDropdown.contains(e.target)) {
          subjectList.style.display = 'none';
          document.removeEventListener('click', handler);
        }
      });

      // Subject select logic
      subjectList.addEventListener('click', function (e) {
        if (e.target.classList.contains('dropdown-option')) {
          subjectSelected.textContent = e.target.textContent;
          subjectSelected.dataset.value = e.target.dataset.name;
          subjectList.style.display = 'none';
        }
      });
    });
}
    // ========== ATTENDANCE + WHATSAPP ===========
    function showAttendancePopup() {
        db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students').orderBy('roll').get()
          .then(snap => {
            let students = [];
            snap.forEach(doc => { if (!doc.data().isDeleted) students.push({ id: doc.id, ...doc.data() }); });
            // Add: Date selection field, default today
            let today = new Date().toISOString().slice(0, 10);
            let html = `
              <form id="attendanceDateForm">
                <div class="popup-title">Select Date for Attendance</div>
                <label for="attendanceDate">Attendance Date</label>
                <input type="date" id="attendanceDate" name="attendanceDate" value="${today}" max="${today}" required style="font-size:1.13em;margin-bottom:10px;">
                <div class="popup-btn-row" style="margin-top:6px;">
                  <button type="button" class="popup-cancel-btn">Cancel</button>
                  <button type="submit" class="popup-action-btn">Next</button>
                </div>
              </form>
            `;
            showPopup(html, 'attendanceDateForm', function(e){
              e.preventDefault();
              let date = e.target.attendanceDate.value;
              if (!date) return;
              // Now show actual attendance form for that date
              showAttendanceEntryForDate(date, students);
            });
          });
      }
      
      // Helper: actual attendance entry UI for a given date
      function showAttendanceEntryForDate(date, students) {
        db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('attendance').doc(date)
          .get()
          .then(attSnap => {
          let attData = attSnap.exists ? attSnap.data() : {};
          let html = `
          <form id="attendanceForm">
            <div class="popup-title">Take Attendance - ${date}</div>
            <div style="max-height:270px;overflow-y:auto;">
               ${students.map(stu => {
                let mChecked = attData[stu.id]?.M === 'absent' ? 'checked' : '';
                let aChecked = attData[stu.id]?.A === 'absent' ? 'checked' : '';
                return `
                  <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f3f3f3;">
                  <div style="display: flex; align-items: center; gap: 6px; min-width: 0;">
                    <span style="width:32px; font-weight:600; color:#1762a7; text-align:right;">
                      ${stu.roll ? stu.roll + '.' : ''}
                    </span>
                    <span style="color:#1762a7; font-weight:600; font-size:1.07em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      ${stu.name}
                    </span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;">
                    <!-- Attendance M/A boxes, right aligned, label above each box -->
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                      <div style="display:flex;gap:16px;margin-bottom:2px;">
                        <span style="font-size:0.97em;font-weight:600;text-align:center;width:26px;">M</span>
                        <span style="font-size:0.97em;font-weight:600;text-align:center;width:26px;">A</span>
                      </div>
                      <div style="display:flex;gap:16px;">
                        <span class="att-box" data-type="M" data-stu="${stu.id}" style="width:26px;height:26px;display:flex;align-items:center;justify-content:center;border:1.7px solid #0f3d6b;border-radius:6px;cursor:pointer;font-size:1.18em;background:#fff;color:#0f3d6b;"></span>
                        <span class="att-box" data-type="A" data-stu="${stu.id}" style="width:26px;height:26px;display:flex;align-items:center;justify-content:center;border:1.7px solid #0f3d6b;border-radius:6px;cursor:pointer;font-size:1.18em;background:#fff;color:#0f3d6b;"></span>
                      </div>
                    </div>
                    ${
                      stu.parentPhone
                      ? `<button type="button" class="wa-btn" data-ph="${stu.parentPhone}" data-name="${stu.name}" data-stuid="${stu.id}" style="background:#25D366; width:34px; height:34px; display:none; align-items:center; justify-content:center; border-radius:50%; border:none; padding:0;">
                            <svg viewBox="0 0 32 32" width="21" height="21">
                              <circle cx="16" cy="16" r="16" fill="#25D366"/>
                              <path fill="#fff" d="M21.6,17.9c-0.3-0.2-1.9-0.9-2.2-1c-0.3-0.1-0.5-0.2-0.7,0.2c-0.2,0.3-0.7,1-0.8,1.2
                                c-0.1,0.2-0.3,0.3-0.6,0.1c-0.3-0.2-1.3-0.5-2.4-1.6c-0.9-0.9-1.5-1.9-1.7-2.2c-0.2-0.3,0-0.5,0.2-0.7c0.2-0.2,0.3-0.4,0.5-0.6
                                c0.2-0.2,0.2-0.3,0.3-0.5c0.1-0.2,0-0.4,0-0.6c0-0.2-0.7-1.8-1-2.5c-0.2-0.6-0.4-0.5-0.6-0.5c-0.2,0-0.4,0-0.7,0
                                c-0.2,0-0.5,0.1-0.8,0.4c-0.2,0.3-1,1-1,2.4c0,1.3,1,2.6,1.2,2.8c0.2,0.3,2,3.2,4.9,4.4c0.7,0.3,1.2,0.4,1.7,0.6
                                c0.7,0.2,1.3,0.2,1.8,0.1c0.5-0.1,1.6-0.7,1.8-1.3c0.2-0.6,0.2-1.2,0.1-1.3C22,18.1,21.9,18.1,21.6,17.9z"/>
                              <path fill="#fff" d="M16,6C10,6,5,11,5,17c0,2.1,0.6,4.1,1.7,5.8L5,27l4.3-1.4C11.9,26.4,13.9,27,16,27c6,0,11-5,11-11S22,6,16,6z
                                M16,25c-1.8,0-3.5-0.4-5.1-1.2l-0.4-0.2l-2.6,0.9l0.9-2.6l-0.2-0.4C7.4,19.5,7,18.3,7,17c0-5,4-9,9-9s9,4,9,9S21,25,16,25z"/>
                            </svg>
                        </button>`
                      : ''
                    }
                  </div>
                </div>
                `;
              }).join('')}
            </div>
            <div class="popup-btn-row" style="margin-top:16px;">
              <button type="button" class="popup-cancel-btn">Cancel</button>
              <button type="submit" class="popup-action-btn">Save Attendance</button>
            </div>
          </form>
          <div style="font-size:0.95em;color:#387c23;margin-top:8px;">
            Tick M for Morning Absentees, A for Afternoon. WhatsApp will message parent.
          </div>
          `;
         showPopup(html, 'attendanceForm', function(e){
          e.preventDefault();
          let form = e.target;
          let attObj = {};
          let absentees = [];
          students.forEach(stu => {
            let mBox = popupContent.querySelector(`.att-box[data-stu="${stu.id}"][data-type="M"]`);
            let aBox = popupContent.querySelector(`.att-box[data-stu="${stu.id}"][data-type="A"]`);
            let m = (mBox && mBox.textContent === 'a') ? 'absent' : 'present';
            let a = (aBox && aBox.textContent === 'a') ? 'absent' : 'present';
            attObj[stu.id] = { M: m, A: a };
            if (m === 'absent' || a === 'absent') {
              absentees.push({
                roll: stu.roll,
                name: stu.name,
                absentM: m === 'absent',
                absentA: a === 'absent'
              });
            }
          });
        
          // If any absentees, show confirmation
          if (absentees.length > 0) {
            let absentHtml = `
              <div class="popup-title">Confirm Absentees</div>
              <div style="max-height:240px;overflow-y:auto;">
                <table style="width:100%;border-collapse:collapse;">
                  <tr style="font-weight:bold;">
                    <td style="border-bottom:1px solid #eee;">Roll</td>
                    <td style="border-bottom:1px solid #eee;">Name</td>
                    <td style="border-bottom:1px solid #eee;">Session</td>
                  </tr>
                  ${
                    absentees.map(stu =>
                      `<tr>
                        <td>${stu.roll || ''}</td>
                        <td>${stu.name}</td>
                        <td>
                          ${stu.absentM ? 'M' : ''}${(stu.absentM && stu.absentA) ? '/' : ''}${stu.absentA ? 'A' : ''}
                        </td>
                      </tr>`
                    ).join('')
                  }
                </table>
                <div style="margin:16px 0;color:#d43f3a;">Are you sure you want to mark these students as absent?</div>
              </div>
              <div class="popup-btn-row">
                <button type="button" class="popup-cancel-btn">No, Go Back</button>
                <button type="button" class="popup-action-btn" id="confirmSaveAttendanceBtn">Yes, Save</button>
              </div>
            `;
           showPopup(absentHtml);
          setTimeout(() => {
            let btn = popupContent.querySelector('#confirmSaveAttendanceBtn');
            if (btn) btn.onclick = function() {
              let attDoc = db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
                .collection('classes').doc(currentClassId)
                .collection('sections').doc(currentSectionId)
                .collection('attendance').doc(date);
              attDoc.set(attObj).then(() => {
                alert("Attendance saved!");
                closePopup();
              });
            }
            // Replace default cancel handler to "go back" to marking
            let cancelBtn = popupContent.querySelector('.popup-cancel-btn');
            if (cancelBtn) cancelBtn.onclick = function() {
              showAttendanceEntryForDate(date, students); // Go back to marking popup!
            }
          }, 120);
          } else {
            // No absentees, just save
            let attDoc = db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('attendance').doc(date);
            attDoc.set(attObj).then(() => {
              alert("Attendance saved!");
              closePopup();
            });
          }
        });
    
    // --- Clickable attendance boxes ("a" toggle) and WhatsApp logic ---
    setTimeout(() => {
      // Make each .att-box clickable
      popupContent.querySelectorAll('.att-box').forEach(box => {
        box.onclick = function() {
          // Toggle "a" when clicked
          if (box.textContent === 'a') {
            box.textContent = '';
            box.style.color = '#0f3d6b';
          } else {
            box.textContent = 'a';
            box.style.color = '#d43f3a';
            box.style.fontWeight = 'bold';
          }
    
          // Show/hide WhatsApp button for this row
          let row = box.closest('div[style*="display: flex"]');
          if (!row) return;
          let mBox = row.querySelector('.att-box[data-type="M"]');
          let aBox = row.querySelector('.att-box[data-type="A"]');
          let waBtn = row.querySelector('.wa-btn');
          if (waBtn) {
            if ((mBox && mBox.textContent === 'a') || (aBox && aBox.textContent === 'a')) {
              waBtn.style.display = 'flex';
            } else {
              waBtn.style.display = 'none';
            }
          }
        };
      });
    
      // Set "a" initially if the student is absent
      popupContent.querySelectorAll('.att-box').forEach(box => {
        let stuId = box.dataset.stu, type = box.dataset.type;
        if (attData[stuId]?.[type] === 'absent') {
          box.textContent = 'a';
          box.style.color = '#d43f3a';
          box.style.fontWeight = 'bold';
        } else {
          box.textContent = '';
          box.style.color = '#0f3d6b';
          box.style.fontWeight = 'bold';
        }
      });
    
      // Show/hide WhatsApp icon initially
      students.forEach(stu => {
        let row = popupContent.querySelector(`.att-box[data-stu="${stu.id}"]`)?.closest('div[style*="display: flex"]');
        if (!row) return;
        let mBox = row.querySelector('.att-box[data-type="M"]');
        let aBox = row.querySelector('.att-box[data-type="A"]');
        let waBtn = row.querySelector('.wa-btn');
        if (waBtn) {
          if ((mBox && mBox.textContent === 'a') || (aBox && aBox.textContent === 'a')) {
            waBtn.style.display = 'flex';
          } else {
            waBtn.style.display = 'none';
          }
        }
      });
    }, 250);

 // WhatsApp button event (unchanged)
          setTimeout(() => {
            popupContent.querySelectorAll('.wa-btn').forEach(btn => {
              btn.onclick = async function() {
  let ph = btn.dataset.ph.replace(/^0+/, '');
  let name = btn.dataset.name;
  let stuid = btn.dataset.stuid;

  // Fetch all attendance records for this section to count absents
  let attSnap = await db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('attendance').get();

  let daysAbsent = 0;
  attSnap.forEach(doc => {
    let data = doc.data()[stuid];
    if (data) {
      let absentM = data.M === 'absent';
      let absentA = data.A === 'absent';
      if (absentM && absentA) {
        daysAbsent += 1;      // full day
      } else if (absentM || absentA) {
        daysAbsent += 0.5;    // half day
      }
    }
  });

  let daysAbsentStr = (Math.round(daysAbsent * 10) / 10).toString();

  let msg = encodeURIComponent(
  `*Dear Parent,*\n\n` +
  `Your child *${name}* is absent today at school. Kindly send reason for absence. *${name}* has been absent for ${daysAbsentStr} day(s) so far this academic year.\n\n` + 
  `*${name}* ఈ రోజు స్కూల్‌కు హాజరు కాలేదు. హాజరు కాకపోవడానికి గల కారణం తెలియజేయగలరు. ఇప్పటి వరకు మొత్తం ${daysAbsentStr} రోజులు అబ్సెంట్ అయ్యారు.\n\n` +
  `Thank you\n` +
  `*${schoolData.name || 'School'}*`
);
  window.open(`https://wa.me/91${ph}?text=${msg}`,'_blank');
}

            });
          }, 400);
    });
}
    function showAttendanceHistoryPopup() {
  // Get attendance docs for this section
  db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('attendance').orderBy(firebase.firestore.FieldPath.documentId()).get()
    .then(snap => {
      if (snap.empty) {
        showPopup(`<div class="popup-title">Attendance History</div>
          <div style="color:#888;">No attendance records found.</div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
        `);
        return;
      }
     let dates = [];
        snap.forEach(doc => dates.push(doc.id));
        
        // Extract unique years and months
        let monthsSet = new Set(), yearsSet = new Set();
        dates.forEach(d => {
          let [y, m] = d.split('-');
          yearsSet.add(y);
          monthsSet.add(m);
        });
        let months = Array.from(monthsSet).sort();
        let years = Array.from(yearsSet).sort();
        let today = new Date();
        let defaultYear = today.getFullYear().toString();
        let defaultMonth = (today.getMonth() + 1).toString().padStart(2, '0');
        
        // Initial selected month/year
        let selectedYear = defaultYear;
        let selectedMonth = defaultMonth;
        
        // Build selects
        function buildMonthYearDropdown(selectedMonth, selectedYear) {
  return `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;">
      <!-- Month Dropdown -->
      <div class="custom-dropdown" id="monthDropdown">
        <div class="dropdown-selected" id="monthSelected">${monthName(selectedMonth)}</div>
        <div class="dropdown-list" id="monthList" style="display:none;">
          ${months.map(m => `<div class="dropdown-option" data-value="${m}">${monthName(m)}</div>`).join('')}
        </div>
      </div>
      <!-- Year Dropdown -->
      <div class="custom-dropdown" id="yearDropdown">
        <div class="dropdown-selected" id="yearSelected">${selectedYear}</div>
        <div class="dropdown-list" id="yearList" style="display:none;">
          ${years.map(y => `<div class="dropdown-option" data-value="${y}">${y}</div>`).join('')}
        </div>
      </div>
    </div>
  `;
}

        function monthName(m) {
          return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1];
        }
        
        // Function to filter and show dates
        function showFilteredDates(selectedMonth, selectedYear) {
          let filteredDates = dates.filter(d => d.startsWith(selectedYear + '-' + selectedMonth));
          filteredDates.sort((a, b) => b.localeCompare(a));
          let listHtml = filteredDates.length === 0
            ? `<div style="color:#888;padding:14px 0;text-align:center;">No attendance found for this month.</div>`
            : filteredDates.map(date => `<button class="popup-action-btn" data-date="${date}" style="padding:8px 12px;font-size:1em;">${formatDate(date)}</button>`).join('');
          popupContent.querySelector('#datesList').innerHTML = listHtml;
        
          // --- ADD THIS: attach click event for new date buttons ---
          popupContent.querySelectorAll('.popup-action-btn[data-date]').forEach(btn => {
            btn.onclick = () => showAttendanceForDate(btn.dataset.date);
          });
        }
         // Initial HTML
        let html = `
          <div class="popup-title">Attendance Dates</div>
          ${buildMonthYearDropdown(selectedMonth, selectedYear)}
          <button id="downloadExcelBtn" style="margin-bottom:10px;padding:6px 16px;background:#2b8e32;color:#fff;border:none;border-radius:6px;float:right;">Download Excel</button>
          <div id="datesList" style="clear:both;max-height:269px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">close</button></div>
        `;
          showPopup(html);
          setTimeout(() => {
            const excelBtn = document.getElementById('downloadExcelBtn');
          if (!excelBtn) return;
          excelBtn.onclick = async function () {
            // Get month & year from selectors
            const month = (() => {
            const m = popupContent.querySelector('#monthSelected');
            return m && m.textContent ? months.find(mm => monthName(mm) === m.textContent) : '';
          })();
          const year = (() => {
            const y = popupContent.querySelector('#yearSelected');
            return y && y.textContent ? y.textContent : '';
          })();
            // Get all students
            let stuSnap = await db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('students').orderBy('roll').get();
            let students = [];
            stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
          
            // Get all attendance docs
            let attSnap = await db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('attendance').get();
          
            // Filter attendance by selected month, get unique dates sorted
            let days = [];
            attSnap.forEach(doc => {
              let d = doc.id; // "YYYY-MM-DD"
              if (d.startsWith(`${year}-${month}`)) days.push(d);
            });
            days.sort();
          
            // Build headers for date/M/A
            let titleRow = [`${currentClassName} ${currentSectionName} (${monthName(month)} ${year})`];
            // Merge this cell across columns in Excel
            let headerRow = ['Roll', 'Name'];
            let subHeaderRow = ['', ''];
            days.forEach(d => {
              let dayNum = d.split('-')[2];
              headerRow.push(dayNum, '');
              subHeaderRow.push('M', 'A');
            });
          
            // Prepare data rows
            let data = [titleRow, headerRow, subHeaderRow];
            students.forEach(stu => {
              let row = [stu.roll, stu.name];
              days.forEach(d => {
                // Default to present if attendance not found
                let attData = attSnap.docs.find(doc => doc.id === d)?.data() || {};
                let statusM = attData[stu.id]?.M === 'absent' ? 'Ab' : 'X';
                let statusA = attData[stu.id]?.A === 'absent' ? 'Ab' : 'X';
                row.push(statusM, statusA);
              });
              data.push(row);
            });
          
            // Export to Excel (SheetJS community)
            let ws = XLSX.utils.aoa_to_sheet(data);
            // Merge the top row
            ws['!merges'] = [{s:{r:0,c:0}, e:{r:0,c:headerRow.length-1}}];
            // Set compact column width
            ws['!cols'] = [{ wch: 5 }, { wch: 18 }, ...Array(days.length * 2).fill({ wch: 3 })];
          
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");
            XLSX.writeFile(wb, `Attendance_${year}-${month}_${currentSectionName}.xlsx`);
          };
          }, 500);
                  
        // Initial render
        showFilteredDates(selectedMonth, selectedYear);
        
        // Add change listeners for custom dropdowns
setTimeout(() => {
  // MONTH DROPDOWN
  const monthDropdown = popupContent.querySelector('#monthDropdown');
  const monthSelected = popupContent.querySelector('#monthSelected');
  const monthList = popupContent.querySelector('#monthList');
  if (monthDropdown && monthSelected && monthList) {
    monthSelected.onclick = function () {
      monthList.style.display = monthList.style.display === 'block' ? 'none' : 'block';
    };
    monthList.querySelectorAll('.dropdown-option').forEach(opt => {
      opt.onclick = function () {
        monthSelected.textContent = this.textContent;
        selectedMonth = this.dataset.value;
        monthList.style.display = 'none';
        showFilteredDates(selectedMonth, selectedYear);
      }
    });
    document.addEventListener('click', function handler(e){
      if (!monthDropdown.contains(e.target)) monthList.style.display = 'none';
    });
  }

  // YEAR DROPDOWN
  const yearDropdown = popupContent.querySelector('#yearDropdown');
  const yearSelected = popupContent.querySelector('#yearSelected');
  const yearList = popupContent.querySelector('#yearList');
  if (yearDropdown && yearSelected && yearList) {
    yearSelected.onclick = function () {
      yearList.style.display = yearList.style.display === 'block' ? 'none' : 'block';
    };
    yearList.querySelectorAll('.dropdown-option').forEach(opt => {
      opt.onclick = function () {
        yearSelected.textContent = this.textContent;
        selectedYear = this.dataset.value;
        yearList.style.display = 'none';
        showFilteredDates(selectedMonth, selectedYear);
      }
    });
    document.addEventListener('click', function handler(e){
      if (!yearDropdown.contains(e.target)) yearList.style.display = 'none';
    });
  }

  // Button click to show that day's attendance
  popupContent.querySelectorAll('.popup-action-btn[data-date]').forEach(btn => {
    btn.onclick = () => showAttendanceForDate(btn.dataset.date);
  });
}, 200);
        
        // Utility
       function formatDate(dateStr) {
  if (!dateStr) return '';
  const [year, month, day] = dateStr.split('-');
  return `${day}-${month}-${year}`;
}

         // Add event handlers for each date button
      setTimeout(() => {
        popupContent.querySelectorAll('button[data-date]').forEach(btn => {
          btn.onclick = function() {
            showAttendanceForDate(this.getAttribute('data-date'));
          }
        });
      }, 100);
    });
}
function showDeletedStudentsPopup() {
  db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('students').orderBy('roll').get()
    .then(snap => {
      let students = [];
snap.forEach(doc => {
  let data = doc.data();
  // Accepts true, "true", or 1 as deleted (for safety)
  if (data.isDeleted === true || data.isDeleted === "true" || data.isDeleted === 1) {
    students.push({ id: doc.id, ...data });
  }
});
let html = `
  <div class="popup-title">Deleted Students</div>
        <div style="max-height:350px;overflow-y:auto;">
          ${
            students.length === 0
              ? `<div style="color:#888;text-align:center;">No deleted students.</div>`
              : students.map(stu => `
                <div style="padding: 14px 0; border-bottom: 1px solid #f3f3f3;">
                  <div style="font-weight:bold; font-size:1.12em; margin-bottom: 6px; text-align:left;">
                    <span style="color:#d43f3a;">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
                  </div>
                  <div style="display:flex; gap:16px; justify-content:center;">
                    <button class="popup-action-btn" style="background:#26bb5a; min-width:115px;" data-restore="${stu.id}">Restore</button>
                    <button class="popup-action-btn" style="background:#d43f3a; min-width:160px;" data-delete="${stu.id}">Delete Permanently</button>
                  </div>
                </div>
              `).join('')
          }
        </div>
        <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
      `;
      showPopup(html);

      // Attach restore handlers
      popupContent.querySelectorAll('button[data-restore]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-restore');
          db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('students').doc(id)
            .update({ isDeleted: firebase.firestore.FieldValue.delete() })
            .then(() => {
              showDeletedStudentsPopup(); // Refresh the list
              renderStudentList(); // Refresh main list if open
            });
        }
      });
      // Attach permanent delete handlers
      popupContent.querySelectorAll('button[data-delete]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-delete');
          if (!confirm("Are you sure you want to permanently delete this student? This cannot be undone!")) return;
          db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('students').doc(id)
            .delete()
            .then(() => {
              showDeletedStudentsPopup(); // Refresh the list
              renderStudentList(); // Refresh main list if open
            });
        }
      });
    });
}
   // ================= CERTIFICATE GENERATOR ==================
async function openCertificateGenerator(prefill = null) {
  showPopup(`
    <div class="popup-title">Generate Certificates</div>

    <label>Select Class</label>
    <div class="custom-dropdown" id="classDropdown" tabindex="0">
      <div class="dropdown-selected" id="classSelected" data-id="">--Select--</div>
      <div class="dropdown-list" id="classList" style="display:none;"></div>
    </div>

    <label>Select Section</label>
    <div class="custom-dropdown" id="sectionDropdown" tabindex="0">
      <div class="dropdown-selected" id="sectionSelected" data-id="">--Select Class First--</div>
      <div class="dropdown-list" id="sectionList" style="display:none;"></div>
    </div>

    <label>Select Exam</label>
    <div class="custom-dropdown" id="examDropdown" tabindex="0">
      <div class="dropdown-selected" id="examSelected" data-id="">--Select Section First--</div>
      <div class="dropdown-list" id="examList" style="display:none;"></div>
    </div>

    <div class="popup-btn-row" style="margin-top:12px;">
      <button type="button" class="popup-cancel-btn">Cancel</button>
      <button type="button" class="popup-action-btn" id="generateCertificatesBtn">Generate</button>
    </div>
  `);

  // 1. Get certificate template URL
  let certUrl = '';
  const schoolDoc = await db.collection('schools').doc(schoolId).get();
  if (schoolDoc.exists && schoolDoc.data().certificateUrl) {
    certUrl = schoolDoc.data().certificateUrl;
  } else {
    alert("Certificate template not uploaded in Firestore!");
    return;
  }

  // 2. Load classes
  const classSnap = await db.collection('schools').doc(schoolId)
    .collection('years').doc(academicYear)
    .collection('classes').orderBy('name').get();

  const classList = document.getElementById('classList');
  const classSelected = document.getElementById('classSelected');
  classList.innerHTML = classSnap.docs.map(doc =>
    `<div class="dropdown-option" data-id="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</div>`
  ).join('');

  classSelected.onclick = () => {
    classList.style.display = classList.style.display === 'none' ? 'block' : 'none';
  };
  classList.querySelectorAll('.dropdown-option').forEach(opt => {
    opt.onclick = () => {
      classSelected.textContent = opt.textContent;
      classSelected.dataset.id = opt.dataset.id;
      classList.style.display = 'none';

      loadSections(opt.dataset.id); // load sections for chosen class
    };
  });
  // ---- PREFILL (if provided) ----
  if (prefill && prefill.classId) {
    const optEl = classList.querySelector(`.dropdown-option[data-id="${prefill.classId}"]`);
    if (optEl) {
      classSelected.textContent = prefill.className || optEl.textContent;
      classSelected.dataset.id = prefill.classId;
      // also prefill section & exam via the loaders
      await loadSections(prefill.classId, prefill.sectionId, prefill.sectionName, prefill.examId, prefill.examName);
    }
  }

  async function loadSections(classId) {
    const sectionSnap = await db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(classId)
      .collection('sections').orderBy('name').get();

    const sectionList = document.getElementById('sectionList');
    const sectionSelected = document.getElementById('sectionSelected');
    sectionList.innerHTML = sectionSnap.docs.map(doc =>
      `<div class="dropdown-option" data-id="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</div>`
    ).join('');

    sectionSelected.textContent = "--Select--";
    sectionSelected.dataset.id = "";
    sectionSelected.onclick = () => {
      sectionList.style.display = sectionList.style.display === 'none' ? 'block' : 'none';
    };

    sectionList.querySelectorAll('.dropdown-option').forEach(opt => {
      opt.onclick = () => {
        sectionSelected.textContent = opt.textContent;
        sectionSelected.dataset.id = opt.dataset.id;
        sectionList.style.display = 'none';

        loadExams(classId, opt.dataset.id); // load exams
      };
    });
  }

  async function loadExams(classId, sectionId, prefillExamId = null, prefillExamName = "") {
  const examSnap = await db.collection('schools').doc(schoolId)
    .collection('years').doc(academicYear)
    .collection('classes').doc(classId)
    .collection('exams').orderBy('name').get();

  const examList = document.getElementById('examList');
  const examSelected = document.getElementById('examSelected');
  examList.innerHTML = examSnap.docs.map(doc =>
    `<div class="dropdown-option" data-id="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</div>`
  ).join('');

  examSelected.textContent = "--Select--";
  examSelected.dataset.id = "";
  examSelected.onclick = () => {
    examList.style.display = examList.style.display === 'none' ? 'block' : 'none';
  };

  examList.querySelectorAll('.dropdown-option').forEach(opt => {
    opt.onclick = () => {
      examSelected.textContent = opt.textContent;
      examSelected.dataset.id = opt.dataset.id;
      examList.style.display = 'none';
    };
  });

  // ---- PREFILL exam (if provided) ----
  if (prefillExamId) {
    const optEl = examList.querySelector(`.dropdown-option[data-id="${prefillExamId}"]`);
    if (optEl) {
      examSelected.textContent = prefillExamName || optEl.textContent;
      examSelected.dataset.id = prefillExamId;
    }
  }
}

  // 3. Generate button
  document.getElementById('generateCertificatesBtn').onclick = async () => {
    const classId = document.getElementById('classSelected').dataset.id;
    const sectionId = document.getElementById('sectionSelected').dataset.id;
    const examId = document.getElementById('examSelected').dataset.id;
    if (!classId || !sectionId || !examId) return alert("Please select class, section, and exam!");

    const stuSnap = await db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(classId)
      .collection('sections').doc(sectionId)
      .collection('students').orderBy('roll').get();

    let students = [];
    stuSnap.forEach(doc => {
      const s = doc.data();
      if (!s.isDeleted) students.push({ id: doc.id, ...s });
    });

    if (!students.length) return alert("No students found!");
    const className = document.getElementById('classSelected')?.textContent || "";
    const sectionName = document.getElementById('sectionSelected')?.textContent || "";
    const examName = document.getElementById('examSelected')?.textContent || "";

    await generateCertificatesForExam(classId, className, sectionId, sectionName, examId, examName, students, certUrl);
 };
   }  
  // ======================= ACTUAL CERTIFICATE GENERATION =========================
async function generateCertificatesForExam(
  classId, className, sectionId, sectionName, examId, examName, students, certUrl
) {
  showPopup(`
    <div class="popup-title">Certificates: ${examName}</div>
    <div style="margin-bottom:12px;color:#555;">
      Certificates will be generated only for the <b>first three ranks</b> (including ties).
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">
  <button class="popup-action-btn" id="certOnePdfBtn">Generate One PDF (All Rankers)</button>
  <button class="popup-action-btn" id="certSeparateBtn">Generate Separate PDFs</button>
  <div style="display:flex; gap:10px; justify-content:center;">
    <button class="popup-action-btn" id="certBackBtn" style="flex:1; background:#eef3f8; color:#0f3d6b;">Back</button>
    <button class="popup-cancel-btn" style="flex:1;">Close</button>
  </div>
</div>
    <div id="downloadStatus" style="margin-top:15px; text-align:center; font-size:1.1em; color:#0f3d6b; display:none;">
      <div id="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #0f3d6b; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 8px;"></div>
      <div id="statusText">Preparing download...</div>
    </div>
       <canvas id="certCanvas" width="2480" height="1754" style="display:none;"></canvas>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `);
  const canvas = document.getElementById('certCanvas');
  const ctx = canvas.getContext('2d');
// spinner + timing helpers (same behavior as single-school)
const statusEl   = document.getElementById("downloadStatus");
const statusText = document.getElementById("statusText");
const nextFrame  = () => new Promise(r => requestAnimationFrame(() => r()));
const sleep      = (ms) => new Promise(r => setTimeout(r, ms));

// compute top-3 rankers (including ties) for this class/section/exam
async function computeTopRankers() {
  // fetch exam definition (subjects list) from multi-school path
  const examDoc = await db.collection('schools').doc(schoolId)
    .collection('years').doc(academicYear)
    .collection('classes').doc(classId)
    .collection('exams').doc(examId).get();

  const exam = examDoc.exists ? examDoc.data() : { subjects: [] };

  // totals per student from marks/{examId}
  for (const stu of students) {
    const mDoc = await db.collection('schools').doc(schoolId)
      .collection('years').doc(academicYear)
      .collection('classes').doc(classId)
      .collection('sections').doc(sectionId)
      .collection('students').doc(stu.id)
      .collection('marks').doc(examId).get();

    const marks = mDoc.exists ? mDoc.data() : {};
    let total = 0;

    // support subjects as array of strings or {name: "..."}
    (exam.subjects || []).forEach(s => {
      const name = typeof s === 'string' ? s : (s && s.name) ? s.name : '';
      if (name) total += Number(marks[name] || 0);
    });

    stu.total = total;
  }

  // sort & assign ranks with ties
  students.sort((a, b) => b.total - a.total);
  let rank = 1;
  for (let i = 0; i < students.length; i++) {
    if (i > 0 && students[i].total < students[i - 1].total) rank = i + 1;
    students[i].rank = rank;
  }

  // top 3 including ties
  return students.filter(s => s.rank <= 3);
}
  // Background from Firestore (your certificate template)
  const bgImg = new Image();
  bgImg.crossOrigin = "anonymous";
  bgImg.src = certUrl;

  // Rank badges
  const rank1Img = new Image(), rank2Img = new Image(), rank3Img = new Image();
  [rank1Img, rank2Img, rank3Img].forEach(i => (i.crossOrigin = "anonymous"));
  rank1Img.src = "https://raw.githubusercontent.com/MessiahSastry/Progress-card-app/main/rank-1.png";
  rank2Img.src = "https://raw.githubusercontent.com/MessiahSastry/Progress-card-app/main/rank-2.png";
  rank3Img.src = "https://raw.githubusercontent.com/MessiahSastry/Progress-card-app/main/rank-3.png";

  // ===== Preload all assets (same approach as single-school) =====
const decodeImg = (img) =>
  ("decode" in img)
    ? img.decode()
    : new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

const withTimeout = (p, ms) =>
  Promise.race([ p, new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), ms)) ]);

const assetsReady = Promise.allSettled([
  withTimeout(decodeImg(bgImg),    8000),
  withTimeout(decodeImg(rank1Img), 4000),
  withTimeout(decodeImg(rank2Img), 4000),
  withTimeout(decodeImg(rank3Img), 4000),
]);

await assetsReady;

  function drawCertificate(stu, rank) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Safe background fallback (parity with single-school)
  if (bgImg && bgImg.naturalWidth > 0) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  } else {
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  ctx.textAlign = "center";

  // Exam name
  ctx.fillStyle = "#000";
  ctx.font = "bold 64px 'Segoe UI'";
  ctx.fillText(examName, 1211, 600);

  // Student Name
  ctx.font = "72px 'Segoe Script'";
  ctx.fillStyle = "#0f3d6b";
  ctx.fillText(stu.name, 1223, 800);

  // Class & Section
  ctx.font = "46px 'Segoe UI'";
  ctx.fillStyle = "#000";
  ctx.fillText(`(${className} / ${sectionName})`, 1214, 880);

  // Rank badge (only if loaded)
  let rankImg = rank === 1 ? rank1Img : rank === 2 ? rank2Img : rank === 3 ? rank3Img : null;
  if (rankImg && rankImg.complete && rankImg.naturalWidth > 0) {
    const w = 300;
    const h = (rankImg.naturalHeight / rankImg.naturalWidth) * w;
    ctx.drawImage(rankImg, 1850, 600, w, h);
  }
}
   const onePdfBtn = document.getElementById("certOnePdfBtn");
const sepPdfBtn = document.getElementById("certSeparateBtn");
const backBtn   = document.getElementById("certBackBtn");
// Back to selection (reopen with prefilled Class/Section/Exam)
backBtn.onclick = () => {
  closePopup();
  openCertificateGenerator({
    classId, className, sectionId, sectionName, examId, examName
  });
};

  onePdfBtn.onclick = async () => {
    // show spinner (like single-school)
    statusEl.style.display = "block";
    statusText.textContent = "Preparing download...";
    await nextFrame(); // paint spinner
    statusText.textContent = "Loading certificate assets...";
    await nextFrame();
    await assetsReady;
    await nextFrame();

    // compute rankers (top 3 incl. ties)
    statusText.textContent = "Calculating ranks…";
    await nextFrame();
    const rankers = await computeTopRankers();
    if (!rankers.length) {
      statusText.textContent = "No rankers found.";
      await sleep(1200);
      statusEl.style.display = "none";
      statusText.textContent = "Preparing download...";
      return;
    }

    // prefer PDFLib (same as single-school); fallback to jsPDF
    const hasPDFLib = !!(window.PDFLib && window.PDFLib.PDFDocument);

    try {
      if (hasPDFLib) {
        const { PDFDocument } = window.PDFLib;
        const pdf = await PDFDocument.create();

        for (let i = 0; i < rankers.length; i++) {
          const stu = rankers[i];
          statusText.textContent = `Generating ${i + 1} of ${rankers.length}…`;
          await nextFrame();

          drawCertificate(stu, stu.rank);
          const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
          const imgBytes = Uint8Array.from(atob(dataUrl.split(",")[1]), c => c.charCodeAt(0));
          const jpg = await pdf.embedJpg(imgBytes);

          // A4 landscape: 842 x 595
          const page = pdf.addPage([842, 595]);
          const s = Math.min(842 / jpg.width, 595 / jpg.height);
          page.drawImage(jpg, {
            x: (842 - jpg.width * s) / 2,
            y: (595 - jpg.height * s) / 2,
            width:  jpg.width * s,
            height: jpg.height * s
          });
        }

        statusText.textContent = "Generating all certificates…";
        await nextFrame();
        const bytes = await pdf.save();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([bytes], { type: "application/pdf" }));
        a.download = `Certificates_${className}_${sectionName}_${examName}.pdf`;
        a.click();

        statusText.textContent = "Download complete!";
        await sleep(1200);
        statusEl.style.display = "none";
        statusText.textContent = "Preparing download...";
        return;
      }

      // ===== Fallback to jsPDF if PDFLib is not present =====
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("l", "px", [canvas.width, canvas.height]);

      for (let i = 0; i < rankers.length; i++) {
        const stu = rankers[i];
        statusText.textContent = `Adding ${i + 1} of ${rankers.length} certificates…`;
        await nextFrame();

        drawCertificate(stu, stu.rank);
        const imgData = canvas.toDataURL("image/png");
        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
      }

      pdf.save(`Certificates_${className}_${sectionName}_${examName}.pdf`);
      statusText.textContent = "Download complete!";
      await sleep(1200);
    } catch (err) {
      console.error(err);
      statusText.textContent = "Something went wrong. Please try again.";
      await sleep(1200);
    } finally {
      statusEl.style.display = "none";
      statusText.textContent = "Preparing download...";
    }
  };

  // ⬇️ NOTE: no extra lone "}" here
  sepPdfBtn.onclick = async () => {
    // show spinner (same UX as single-school)
    statusEl.style.display = "block";
    statusText.textContent = "Preparing download...";
    await nextFrame(); // paint spinner
    statusText.textContent = "Loading certificate assets...";
    await nextFrame();
    await assetsReady;
    await nextFrame();

    // compute rankers (top 3 incl. ties)
    statusText.textContent = "Calculating ranks…";
    await nextFrame();
    const rankers = await computeTopRankers();
    if (!rankers.length) {
      statusText.textContent = "No rankers found.";
      await sleep(1200);
      statusEl.style.display = "none";
      statusText.textContent = "Preparing download...";
      return;
    }

    try {
      const hasPDFLib = !!(window.PDFLib && window.PDFLib.PDFDocument);

      for (let i = 0; i < rankers.length; i++) {
        const stu = rankers[i];

        statusText.textContent = `Generating ${i + 1} of ${rankers.length}…`;
        await nextFrame();

        drawCertificate(stu, stu.rank);

        if (hasPDFLib) {
          const { PDFDocument } = window.PDFLib;
          const one = await PDFDocument.create();
          const dataUrl  = canvas.toDataURL("image/jpeg", 0.95);
          const imgBytes = Uint8Array.from(atob(dataUrl.split(",")[1]), c => c.charCodeAt(0));
          const jpg      = await one.embedJpg(imgBytes);

          const page = one.addPage([842, 595]);
          const s = Math.min(842 / jpg.width, 595 / jpg.height);
          page.drawImage(jpg, {
            x: (842 - jpg.width * s) / 2,
            y: (595 - jpg.height * s) / 2,
            width:  jpg.width * s,
            height: jpg.height * s
          });

          statusText.textContent = "Saving certificate…";
          await nextFrame();
          const bytes = await one.save();
          const a = document.createElement("a");
          a.href = URL.createObjectURL(new Blob([bytes], { type: "application/pdf" }));
          a.download = `Certificate_${stu.name}_${className}_${sectionName}_${examName}.pdf`;
          a.click();
        } else {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("l", "px", [canvas.width, canvas.height]);
          const imgData = canvas.toDataURL("image/png");
          pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);

          statusText.textContent = "Saving certificate…";
          await nextFrame();
          pdf.save(`Certificate_${stu.name}_${className}_${sectionName}_${examName}.pdf`);
        }
      }

      statusText.textContent = "All certificates saved!";
      await sleep(1200);
    } catch (err) {
      console.error(err);
      statusText.textContent = "Something went wrong. Please try again.";
      await sleep(1200);
    } finally {
      statusEl.style.display = "none";
      statusText.textContent = "Preparing download...";
    }
  };
} 

// View attendance for one date
function showAttendanceForDate(date) {
  // Load student list
  db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId).collection('students').orderBy('roll').get()
    .then(stuSnap => {
      let students = [];
      stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));

      // Load all attendance docs for absence counts
     db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
        .collection('sections').doc(currentSectionId).collection('attendance').get()
        .then(allAttSnap => {
          let attDataByDate = {};
          let totalDays = 0;
          allAttSnap.forEach(d => {
            attDataByDate[d.id] = d.data();
            totalDays++;
          });

          // Load this date’s attendance
          db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId).collection('attendance').doc(date).get()
            .then(attSnap => {
              let att = attSnap.data() || {};

              let html = `<div class="popup-title">Attendance: ${formatDate(date)}</div>
                <div style="max-height:290px;overflow-y:auto;">`;

              students.forEach(stu => {
  let daysAbsent = 0;
  let totalDays = Object.keys(attDataByDate).length;
  for (let d in attDataByDate) {
    let st = attDataByDate[d][stu.id] || {};
    const absentM = st.M === 'absent';
    const absentA = st.A === 'absent';
    if (absentM && absentA) {
      daysAbsent += 1;           // Full day absent
    } else if (absentM || absentA) {
      daysAbsent += 0.5;         // Half day absent
    }
  }
  // Format daysAbsent to show .5 if needed, else as integer
  let daysAbsentStr = daysAbsent % 1 === 0 ? daysAbsent.toString() : daysAbsent.toFixed(1);

  let stat = att[stu.id] || {};
  let statM = (stat.M || 'present').toLowerCase();
  let statA = (stat.A || 'present').toLowerCase();
  let badgeM = `<span class="att-badge att-m-${statM}">M: ${statM === 'absent' ? 'Ab' : 'Pr'}</span>`;
  let badgeA = `<span class="att-badge att-a-${statA}">A: ${statA === 'absent' ? 'Ab' : 'Pr'}</span>`;
  let totalBox = `<span class="att-total-box">${daysAbsentStr} / ${totalDays}</span>`;
  html += `
    <div class="att-row">
      <div class="att-main">
        <span class="att-name">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
        <div class="att-badges">
          ${badgeM}
          ${badgeA}
        </div>
      </div>
      ${totalBox}
    </div>
  `;
});
              html += `</div>
                <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
              `;
              showPopup(html);
              // --- Modern Dropdown JS for Month & Year (Attendance History) ---
              setTimeout(() => {
                // MONTH DROPDOWN
                const monthDropdown = popupContent.querySelector('#monthDropdown');
                const monthSelected = popupContent.querySelector('#monthSelected');
                const monthList = popupContent.querySelector('#monthList');
                if(monthDropdown) {
                  monthSelected.onclick = function () {
                    monthList.style.display = monthList.style.display === 'block' ? 'none' : 'block';
                  };
                  monthList.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.onclick = function () {
                      monthSelected.textContent = this.textContent;
                      selectedMonth = this.dataset.value;
                      monthList.style.display = 'none';
                      showFilteredDates(selectedMonth, selectedYear);
                    }
                  });
                  document.addEventListener('click', function handler(e){
                    if (!monthDropdown.contains(e.target)) monthList.style.display = 'none';
                  });
                }
                // YEAR DROPDOWN
                const yearDropdown = popupContent.querySelector('#yearDropdown');
                const yearSelected = popupContent.querySelector('#yearSelected');
                const yearList = popupContent.querySelector('#yearList');
                if(yearDropdown) {
                  yearSelected.onclick = function () {
                    yearList.style.display = yearList.style.display === 'block' ? 'none' : 'block';
                  };
                  yearList.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.onclick = function () {
                      yearSelected.textContent = this.textContent;
                      selectedYear = this.dataset.value;
                      yearList.style.display = 'none';
                      showFilteredDates(selectedMonth, selectedYear);
                    }
                  });
                  document.addEventListener('click', function handler(e){
                    if (!yearDropdown.contains(e.target)) yearList.style.display = 'none';
                  });
                }
              }, 300);
            });
        });
    });
}
// Helper to show date as DD-MM-YYYY
function formatDate(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  return `${d}-${m}-${y}`;
}
    function showBulkStudentUploadPopup() {
  showPopup(`
    <div class="popup-title">Upload Students (Excel)</div>
    <input type="file" id="studentFileInput" accept=".xlsx,.csv" style="margin-bottom:15px;" />
    <div style="font-size:0.97em; color:#555; margin-bottom:10px;">
      Please upload an Excel (.xlsx) or CSV file with columns: <b>Roll, Name, Father, ParentPhone</b>.
    </div>
    <div class="popup-btn-row">
      <button type="button" class="popup-cancel-btn">Cancel</button>
      <button type="button" class="popup-action-btn" id="doBulkUploadBtn">Upload</button>
    </div>
  `);

  document.getElementById('doBulkUploadBtn').onclick = function() {
    const fileInput = document.getElementById('studentFileInput');
    if (!fileInput.files.length) {
      alert('Please select a file!');
      return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      let data = new Uint8Array(e.target.result);
      let workbook = XLSX.read(data, {type: 'array'});
      let sheet = workbook.Sheets[workbook.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval: ''});
      let headers = rows[0].map(x => x.toString().toLowerCase().trim());
      let nameIdx = headers.findIndex(h => h === 'name');
      let rollIdx = headers.findIndex(h => h === 'roll');
      let fatherIdx = headers.findIndex(h => h === 'father');
      let phoneIdx = headers.findIndex(h => h.includes('phone'));
      if (nameIdx < 0 || rollIdx < 0 || fatherIdx < 0) {
        alert('Excel must have headers: Roll, Name, Father, ParentPhone');
        return;
      }
      let students = [];
      for (let i=1; i<rows.length; i++) {
        let row = rows[i];
        if (!row[nameIdx]) continue;
        const roll = toRoll(row[rollIdx]);
if (roll === null) { continue; }  // skip invalid roll rows

const rawPhone = phoneIdx >= 0 ? row[phoneIdx] : '';
const phone = normalizePhone(rawPhone);

students.push({
  name: row[nameIdx].toString().trim().toUpperCase(),
father: row[fatherIdx].toString().trim().toUpperCase(),
  roll,
  parentPhone: isValidPhone(phone) ? phone : ""
});
      }
      if (students.length === 0) {
        alert('No valid students found!');
        return;
      }
      // Upload students in batch
      let batch = db.batch();
      let sectionRef = db.collection('schools').doc(schoolId).collection('years').doc(academicYear).collection('classes').doc(currentClassId)
        .collection('sections').doc(currentSectionId).collection('students');
      students.forEach(stu => {
        let ref = sectionRef.doc();
        batch.set(ref, stu);
      });
      batch.commit().then(() => {
        alert("All students uploaded!");
        closePopup();
        renderStudentList();
      }).catch(e => {
        alert("Error uploading students: " + e.message);
      });
    };
    reader.readAsArrayBuffer(file);
  }
}
    // ---- Absentees Modal Open/Close ----
function openAbsenteesModal() {
  document.getElementById('absenteesModalBg').style.display = 'flex';
  document.getElementById('absenteesIframe').src = 'absentees-report.html';
}

function closeAbsenteesModal() {
  document.getElementById('absenteesModalBg').style.display = 'none';
  document.getElementById('absenteesIframe').src = '';
}
  </script>
  <!-- Absentees Report Modal -->
<div id="absenteesModalBg" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:#0007;z-index:2003;align-items:center;justify-content:center;">
  <div id="absenteesModalContent" style="background:#fff;border-radius:16px;box-shadow:0 8px 30px #0f3d6b22;padding:0;min-width:320px;max-width:97vw;width:780px;display:flex;flex-direction:column;gap:0;align-items:stretch;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 24px 10px 18px;">
      <span style="font-size:1.23em;font-weight:700;color:#0f3d6b;">Absentees Report</span>
      <button id="closeAbsenteesModal" style="background:none;border:none;font-size:1.55em;color:#0f3d6b;cursor:pointer;padding:0 8px;">&times;</button>
    </div>
    <iframe id="absenteesIframe" src="" style="border:none;width:100%;height:75vh;border-radius:0 0 16px 16px;"></iframe>
  </div>
</div>
   <script>
  document.getElementById('closeAbsenteesModal').onclick = closeAbsenteesModal;
  document.getElementById('absenteesModalBg').onclick = function(e) {
    if (e.target === this) closeAbsenteesModal();
  };
        function showBulkMarksUploadPopup() {
    db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
  .collection('classes').doc(currentClassId)
  .collection('exams').orderBy('name').get()
    .then(examSnap => {
      let exams = [];
      examSnap.forEach(doc => exams.push({ id: doc.id, ...doc.data() }));
      if (exams.length === 0) {
        showPopup(`<div class="popup-title">Upload Marks</div>
          <div style="margin:16px 0;">No exams found! Please add exams first.</div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
        `);
        return;
      }
      let html = `
        <div class="popup-title">Upload Marks (Excel)</div>
        <label>Select Exam</label>
        <div class="custom-dropdown" id="examDropdown" tabindex="0">
          <div class="dropdown-selected" id="examSelected" data-value="">--Select--</div>
          <div class="dropdown-list" id="examList" style="display:none;"></div>
        </div>
        <input type="file" id="marksFileInput" accept=".xls,.xlsx" style="margin:12px 0 15px 0;" />
        <div style="font-size:0.97em; color:#555; margin-bottom:10px;">
          Please upload the Evalbee Excel file.<br>
          Only <b>Roll number</b> is matched; subject marks will be updated for this exam only.
        </div>
        <div class="popup-btn-row">
          <button type="button" class="popup-cancel-btn">Cancel</button>
          <button type="button" class="popup-action-btn" id="doBulkMarksUploadBtn">Upload</button>
        </div>
      `;
      showPopup(html);

      // Populate exam dropdown
      const examDropdown = popupContent.querySelector('#examDropdown');
      const examSelected = popupContent.querySelector('#examSelected');
      const examList = popupContent.querySelector('#examList');
      examList.innerHTML = exams.map(e => `
        <div class="dropdown-option" data-id="${e.id}" style="padding:10px 12px;cursor:pointer;">
          ${e.name}
        </div>
      `).join('');
      examSelected.onclick = function () {
        examList.style.display = (examList.style.display === 'none' || examList.style.display === '') ? 'block' : 'none';
      };
      document.addEventListener('click', function handler(e) {
        if (!examDropdown.contains(e.target)) {
          examList.style.display = 'none';
          document.removeEventListener('click', handler);
        }
      });
      let selectedExam = null;
      examList.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.onclick = function () {
          examSelected.textContent = this.textContent;
          examSelected.dataset.value = this.dataset.id;
          examList.style.display = 'none';
          selectedExam = exams.find(e => e.id === this.dataset.id);
        };
      });

      document.getElementById('doBulkMarksUploadBtn').onclick = async function() {
        const fileInput = document.getElementById('marksFileInput');
        if (!fileInput.files.length) return alert('Please select a file!');
        if (!selectedExam) return alert('Please select an exam!');
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async function(e) {
          let data = new Uint8Array(e.target.result);
          let workbook = XLSX.read(data, {type: 'array'});
          let sheet = workbook.Sheets[workbook.SheetNames[0]];
          let rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval: ''});

          // Map Excel columns
          let headers = rows[0].map(x => x.toString().trim().toLowerCase());
          let rollIdx = 2; // Usually column C (index 2)
          // let rollIdx = headers.findIndex(h => h === 'roll' || h.startsWith('roll'));
          let colIndexes = {};
          let missingSubjects = [];
          selectedExam.subjects.forEach(subj => {
            let idx = headers.findIndex(h => h.includes(subj.name.toLowerCase()));
            if (idx === -1) {
              // Fallback mapping
              if (subj.name.toLowerCase() === 'math') idx = 10;
              if (subj.name.toLowerCase() === 'physics') idx = 11;
              if (subj.name.toLowerCase() === 'chemistry') idx = 12;
              if (subj.name.toLowerCase() === 'biology') idx = 13;
            }
            colIndexes[subj.name] = idx;
            if (idx === -1) missingSubjects.push(subj.name);
          });

          // Get all students for this section
          let stuSnap = await db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
            .collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('students').orderBy('roll').get();
          let students = [];
          stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));

          let batch = db.batch();
          let updates = 0;
          let matchedRolls = [];
          let notFoundRolls = [];
          let foundRollSet = new Set(students.map(s => parseInt(s.roll)));

          for (let i = 1; i < rows.length; i++) {
            let row = rows[i];
            let roll = parseInt(row[rollIdx]);
            if (isNaN(roll)) continue;
            let stu = students.find(s => parseInt(s.roll) === roll);
            if (!stu) {
              notFoundRolls.push(roll);
              continue;
            }
            matchedRolls.push(roll);

            // Build marks object for this exam's subjects
            let marksObj = {};
            selectedExam.subjects.forEach(subj => {
              let idx = colIndexes[subj.name];
              if (typeof idx === "number" && idx >= 0) {
                let val = row[idx];
                marksObj[subj.name] = isNaN(val) ? 0 : Number(val);
              }
            });

            // Save under students/{id}/marks/{examId}
            let markRef = db.collection('schools').doc(schoolId).collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('students').doc(stu.id)
              .collection('marks').doc(selectedExam.id);

            batch.set(markRef, marksObj, { merge: true });
            updates++;
          }
          if (updates === 0) {
            alert('No matching students found by roll number!');
            return;
          }
          await batch.commit();

          // --- Build the Summary Message ---
          let summary = `<div class="popup-title">Upload Summary</div>
            <div style="font-size:1.1em;margin-bottom:7px;"><b>${updates}</b> students updated!</div>`;

          if (matchedRolls.length > 0) {
            summary += `<div><b>Matched Roll Numbers:</b><br>
              <span style="font-size:.97em;">${matchedRolls.sort((a,b)=>a-b).join(', ')}</span></div>`;
          }
          if (notFoundRolls.length > 0) {
            summary += `<div style="margin-top:9px;"><b>Roll Numbers NOT found:</b><br>
              <span style="color:#d43f3a;">${notFoundRolls.sort((a,b)=>a-b).join(', ')}</span></div>`;
          }
          if (missingSubjects.length > 0) {
            summary += `<div style="margin-top:10px;"><b>Subjects in Exam <span style="color:#0f3d6b;">not found in Excel header</span>:</b><br>
              <span style="color:#d43f3a;">${missingSubjects.join(', ')}</span>
              <br><span style="font-size:.97em;color:#999;">Check spelling or header row in Excel.</span>
              </div>`;
          }
          summary += `<div class="popup-btn-row" style="margin-top:18px;"><button class="popup-action-btn">Close</button></div>`;

          showPopup(summary);
          setTimeout(() => {
          let closeBtn = popupContent.querySelector('.popup-action-btn');
          if (closeBtn) closeBtn.onclick = closePopup;
        }, 100);
        };
        reader.readAsArrayBuffer(file);
      }
    });
}
</script>
</body>
</html>


